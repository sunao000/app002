<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ルート検索デモ</title>
  <style>
    #locationList li {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>ルート検索</h1>
  <label>
    <input type="checkbox" id="locationFilterToggle" checked />
    近くの場所のみに制限
  </label>
  <br /><br />
  <input id="placeInput" type="text" placeholder="地名を入力" />
  <button onclick="searchPlace()">検索して追加</button>
  <button onclick="addCurrentLocation()">現在地を追加</button>
  <ul id="locationList"></ul>

  <script>
    let locationList = [];
    let locationFilterEnabled = true;
    let currentPosition = null;

    document.getElementById("locationFilterToggle").addEventListener("change", (e) => {
      locationFilterEnabled = e.target.checked;
    });

    // リアルタイム位置更新
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        (position) => {
          currentPosition = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };
        },
        (err) => {
          console.error("位置情報の取得に失敗:", err);
        },
        { enableHighAccuracy: true }
      );
    }

    function getPlaceFromInput() {
      return document.getElementById("placeInput").value;
    }

    async function searchPlace() {
      const place = getPlaceFromInput();
      if (!place) return;

      let url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(place)}&format=json`;

      if (locationFilterEnabled && currentPosition) {
        url += `&viewbox=${currentPosition.lng - 0.05},${currentPosition.lat + 0.05},${currentPosition.lng + 0.05},${currentPosition.lat - 0.05}&bounded=1`;
      }

      const response = await fetch(url);
      const results = await response.json();

      if (results.length > 0) {
        const first = results[0];
        addLocation({ name: first.display_name, lat: first.lat, lng: first.lon });
      } else {
        alert("地名が見つかりませんでした");
      }
    }

    function addCurrentLocation() {
      if (!currentPosition) {
        alert("現在地がまだ取得されていません。少し待ってください。");
        return;
      }

      const name = `現在地（${currentPosition.lat.toFixed(5)}, ${currentPosition.lng.toFixed(5)}）`;
      addLocation({ name: name, lat: currentPosition.lat, lng: currentPosition.lng });
    }

    function addLocation(location) {
      locationList.push(location);
      renderLocationList();
    }

    function removeLocation(index) {
      locationList.splice(index, 1);
      renderLocationList();
    }

    function renderLocationList() {
      const ul = document.getElementById("locationList");
      ul.innerHTML = "";

      locationList.forEach((loc, index) => {
        const li = document.createElement("li");

        let label = "経由地";
        if (index === 0) label = "出発地";
        else if (index === locationList.length - 1) label = "目的地";

        li.innerHTML = `${label}: ${loc.name} <button onclick="removeLocation(${index})">削除</button>`;
        ul.appendChild(li);
      });
    }
  </script>
</body>
</html>
