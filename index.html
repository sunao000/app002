<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>リアルタイム現在地追跡付きルート案内アプリ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 500px; }
    #controls { margin: 10px 0; }
    #pointList { list-style: none; padding-left: 0; }
    #pointList li { padding: 4px; border: 1px solid #ccc; margin-bottom: 4px; background: #fafafa; cursor: move; }
  </style>
</head>
<body>
  <h2>リアルタイム現在地追跡付きルート案内アプリ</h2>

  <div id="controls">
    <button id="startTrackingBtn">現在地追跡開始</button>
    <button id="stopTrackingBtn" disabled>現在地追跡停止</button>
    <button id="clearPointsBtn">地点クリア</button>
    <ul id="pointList"></ul>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // 地図初期化（東京駅付近）
    const map = L.map('map').setView([35.681236, 139.767125], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
    }).addTo(map);

    let points = [];
    let markers = [];
    let currentRoute = null;

    const pointList = document.getElementById('pointList');
    const startTrackingBtn = document.getElementById('startTrackingBtn');
    const stopTrackingBtn = document.getElementById('stopTrackingBtn');
    const clearPointsBtn = document.getElementById('clearPointsBtn');

    let watchId = null;
    let currentPositionMarker = null;

    // 登録地点リスト表示関数（役割＋地名表示）
    function refreshPointList() {
      pointList.innerHTML = '';
      points.forEach((pt, i) => {
        const li = document.createElement('li');
        li.textContent = (i === 0 ? '出発地' : (i === points.length - 1 ? '目的地' : `経由地${i}`)) +
                         `：${pt.name || pt.lat.toFixed(6) + ',' + pt.lng.toFixed(6)}`;
        li.dataset.index = i;
        pointList.appendChild(li);
      });
    }

    // 現在地取得をリアルタイム追跡（高精度）
    function startTracking() {
      if (!navigator.geolocation) {
        alert('Geolocationはサポートされていません');
        return;
      }
      if (watchId !== null) {
        alert('すでに追跡中です');
        return;
      }

      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const accuracy = pos.coords.accuracy;

          // 現在地マーカー更新
          if (currentPositionMarker) {
            currentPositionMarker.setLatLng([lat, lng]);
          } else {
            currentPositionMarker = L.marker([lat, lng], {
              title: '現在地',
              icon: L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/64/64113.png',
                iconSize: [30, 30],
                iconAnchor: [15, 30],
              }),
            }).addTo(map);
          }

          // マップ中心自動追従（オプション）
          map.setView([lat, lng], 16);

          // 追跡中は「現在地」地点をpoints配列の先頭に更新または追加
          if (points.length === 0) {
            points.push({ lat, lng, name: '現在地' });
            markers.push(currentPositionMarker);
          } else {
            points[0] = { lat, lng, name: '現在地' };
            // markers[0]はcurrentPositionMarkerとして使うので更新は不要
          }

          refreshPointList();
        },
        (err) => {
          alert('現在地の取得に失敗しました: ' + err.message);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 10000,
        }
      );

      startTrackingBtn.disabled = true;
      stopTrackingBtn.disabled = false;
    }

    // 現在地追跡停止
    function stopTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        startTrackingBtn.disabled = false;
        stopTrackingBtn.disabled = true;
      }
    }

    startTrackingBtn.addEventListener('click', startTracking);
    stopTrackingBtn.addEventListener('click', stopTracking);

    clearPointsBtn.addEventListener('click', () => {
      points = [];
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      if (currentRoute) {
        map.removeLayer(currentRoute);
        currentRoute = null;
      }
      if (currentPositionMarker) {
        map.removeLayer(currentPositionMarker);
        currentPositionMarker = null;
      }
      refreshPointList();
    });
  </script>
</body>
</html>
