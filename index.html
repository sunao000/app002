<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>カスタムルート探索（並び替え対応）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; display: flex; height: 100vh; }
    #map { flex: 1; }
    #control-panel {
      width: 300px; padding: 10px; background: #f9f9f9; overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    #waypoint-list { list-style: none; padding: 0; margin: 0; }
    #waypoint-list li {
      display: flex; align-items: center; margin-bottom: 5px;
      background: #fff; padding: 5px; border: 1px solid #ddd; cursor: grab;
    }
    #waypoint-list li span { flex: 1; }
    #waypoint-list li button {
      border: none; background: transparent; font-size: 1em; cursor: pointer;
      margin-left: 5px;
    }
    #add-form { display: flex; margin-bottom: 10px; }
    #add-form input { flex: 1; padding: 5px; }
    #add-form button { padding: 5px 10px; }
  </style>
</head>
<body>
  <div id="control-panel">
    <h3>経由地リスト</h3>
    <form id="add-form">
      <input type="text" id="place-input" placeholder="地名を入力" />
      <button type="submit">追加</button>
    </form>
    <ul id="waypoint-list"></ul>
    <button id="draw-route">ルート描画</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script>
    const map = L.map('map').setView([35.681236, 139.767125], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const waypoints = [];
    const markers = [];
    let routeLine;

    const listEl = document.getElementById('waypoint-list');
    const form = document.getElementById('add-form');
    const input = document.getElementById('place-input');
    const drawBtn = document.getElementById('draw-route');

    // Sortable for drag-and-drop
    Sortable.create(listEl, { animation: 150 });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const place = input.value.trim();
      if (!place) return;
      // Geocode via Nominatim
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`);
      const data = await res.json();
      if (data.length === 0) { alert('場所が見つかりませんでした'); return; }
      const { lat, lon, display_name } = data[0];
      waypoints.push({ name: display_name, lat: +lat, lon: +lon });
      addListItem(display_name);
      input.value = '';
    });

    function addListItem(name) {
      const li = document.createElement('li');
      li.innerHTML = `<span>${name}</span><button class="delete">✕</button>`;
      listEl.appendChild(li);
      li.querySelector('.delete').addEventListener('click', () => {
        const idx = Array.from(listEl.children).indexOf(li);
        waypoints.splice(idx, 1);
        listEl.removeChild(li);
      });
    }

    drawBtn.addEventListener('click', () => {
      if (routeLine) map.removeLayer(routeLine);
      // Clear old markers
      markers.forEach(m => map.removeLayer(m));
      markers.length = 0;

      // Rebuild waypoints order
      const ordered = Array.from(listEl.children).map((li, i) => waypoints[i]);
      // Place markers
      ordered.forEach(wp => {
        const m = L.marker([wp.lat, wp.lon]).addTo(map).bindPopup(wp.name);
        markers.push(m);
      });
      // Draw straight-line polyline
      const latlngs = ordered.map(wp => [wp.lat, wp.lon]);
      routeLine = L.polyline(latlngs, { color: 'blue' }).addTo(map);
      map.fitBounds(routeLine.getBounds().pad(0.5));
    });
  </script>
</body>
</html>
