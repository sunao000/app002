<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ã‚¢ãƒ—ãƒª</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 500px; }
    #controls { margin: 10px 0; }
    #pointList li { list-style: none; margin: 4px 0; padding: 6px; border: 1px solid #ccc; background: #f9f9f9; }
    #searchResults li:hover { background-color: #eee; cursor: pointer; }
  </style>
</head>
<body>
  <h2>ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ã‚¢ãƒ—ãƒª</h2>

  <div id="controls">
    <input id="placeInput" type="text" placeholder="åœ°åã‚’å…¥åŠ›" style="width: 300px;" />
    <button id="searchPlaceBtn">åœ°åæ¤œç´¢</button>
    <ul id="searchResults"></ul>

    <br>

    <button id="addCurrentBtn">ğŸ“ ç¾åœ¨åœ°ã‚’è¿½åŠ </button>
    <button id="clearPointsBtn">åœ°ç‚¹ã‚¯ãƒªã‚¢</button>
    <button id="openGoogleMapsBtn">Google Mapsã§é–‹ã</button>

    <h3>ç™»éŒ²åœ°ç‚¹</h3>
    <ul id="pointList"></ul>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([35.681236, 139.767125], 13); // æ±äº¬é§…
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
    }).addTo(map);

    let points = [];
    let markers = [];

    const placeInput = document.getElementById('placeInput');
    const searchPlaceBtn = document.getElementById('searchPlaceBtn');
    const searchResults = document.getElementById('searchResults');
    const pointList = document.getElementById('pointList');
    const clearPointsBtn = document.getElementById('clearPointsBtn');
    const openGoogleMapsBtn = document.getElementById('openGoogleMapsBtn');
    const addCurrentBtn = document.getElementById('addCurrentBtn');

    function addPoint(lat, lng, label) {
      points.push({ lat, lng, label });
      const marker = L.marker([lat, lng]).addTo(map);
      marker.bindPopup(label).openPopup();
      markers.push(marker);
      map.setView([lat, lng], 14);
      refreshPointList();
    }

    function refreshPointList() {
      pointList.innerHTML = '';
      points.forEach((pt, i) => {
        const li = document.createElement('li');
        li.textContent = `${i + 1}. ${pt.label} (${pt.lat.toFixed(5)}, ${pt.lng.toFixed(5)})`;
        pointList.appendChild(li);
      });
    }

    // åœ°åæ¤œç´¢
    searchPlaceBtn.addEventListener('click', () => {
      const query = placeInput.value.trim();
      if (!query) return;

      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(results => {
          searchResults.innerHTML = '';
          if (results.length === 0) {
            searchResults.innerHTML = '<li>è©²å½“ã™ã‚‹å ´æ‰€ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</li>';
            return;
          }

          results.forEach(result => {
            const li = document.createElement('li');
            li.textContent = result.display_name;
            li.addEventListener('click', () => {
              addPoint(parseFloat(result.lat), parseFloat(result.lon), result.display_name);
              searchResults.innerHTML = '';
              placeInput.value = '';
            });
            searchResults.appendChild(li);
          });
        })
        .catch(err => {
          console.error('æ¤œç´¢å¤±æ•—', err);
          alert('åœ°åæ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    });

    // ç¾åœ¨åœ°å–å¾—
    addCurrentBtn.addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('ç¾åœ¨åœ°å–å¾—ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          addPoint(latitude, longitude, 'ç¾åœ¨åœ°');
        },
        err => {
          alert('ç¾åœ¨åœ°å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
        }
      );
    });

    // ã‚¯ãƒªã‚¢
    clearPointsBtn.addEventListener('click', () => {
      points = [];
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
      pointList.innerHTML = '';
    });

    // Google Mapsã§é–‹ã
    openGoogleMapsBtn.addEventListener('click', () => {
      if (points.length < 2) {
        alert('2åœ°ç‚¹ä»¥ä¸Šã‚’ç™»éŒ²ã—ã¦ãã ã•ã„');
        return;
      }
      const url = `https://www.google.com/maps/dir/${points.map(p => `${p.lat},${p.lng}`).join('/')}`;
      window.open(url, '_blank');
    });
  </script>
</body>
</html>
