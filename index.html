<!--
  ğŸš² Route Compare + Autoâ€‘Rest FULL v7.0  (2025â€‘08â€‘05)
  â€¢ æœ€çŸ­ / æœ€é€Ÿ / å‹¾é…ãƒ«ãƒ¼ãƒˆ
  â€¢ 4 æ–¹å¼ä¼‘æ†© (æ™‚é–“ / ç´¯ç© kJ / kJâ€‘rate / ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰)
  â€¢ Overpass ã§ POI æ¤œç´¢ãƒ»è‡ªå‹•æŒ¿å…¥
  â€¢ SortableJS, Leaflet, Nominatim
  â€» OpenRouteService API ã‚­ãƒ¼ã‚’ const ORS_KEY ã«å¿…ãšè¨­å®šã—ã¦ãã ã•ã„
-->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>è‡ªè»¢è»Šãƒ«ãƒ¼ãƒˆæ¯”è¼ƒ + è‡ªå‹•ä¼‘æ†© v7.0</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js" defer></script>
<style>
 body{margin:0;font-family:system-ui,sans-serif}
 #map{height:520px;width:100%}
 #controls{display:flex;flex-wrap:wrap;gap:8px;padding:8px;background:#f8f8f8}
 #pointList{list-style:none;margin:0;padding:0}
 #pointList li{display:flex;align-items:center;justify-content:space-between;padding:4px 8px;border:1px solid #ccc;background:#fafafa;margin-bottom:4px;cursor:move}
 button.del{background:#d9534f;color:#fff;border:none;border-radius:4px;padding:0 8px;font-size:12px}
 #searchResults{position:absolute;z-index:1000;width:260px;max-height:200px;overflow-y:auto;margin:4px 0 0;padding:0;list-style:none;border:1px solid #ccc;background:#fff}
 #searchResults li{padding:4px 8px;cursor:pointer}
 #searchResults li:hover{background:#eaeaea}
 .group{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
 .presetKJ{border:1px solid #ccc;border-radius:14px;padding:2px 8px;font-size:.85em;background:#fff;cursor:pointer}
 #summary{padding:8px;background:#fafafa;border-top:1px solid #ddd;font-size:.9rem}
 details>summary{cursor:pointer}
</style>
</head>
<body>
<div id="controls">
  <input id="placeInput" placeholder="åœ°åãƒ»ä½æ‰€" style="width:260px" autocomplete="off">
  <button id="searchBtn">æ¤œç´¢</button>
  <button id="locBtn">ç¾åœ¨åœ°è¿½åŠ </button>
  <input id="restToggle" type="checkbox" hidden checked>
  <button id="restModeBtn">ä¼‘æ†©è¾¼ã¿: ON</button>
  <label>åŸºæº–
    <select id="restBasis">
      <option value="time">æ™‚é–“</option>
      <option value="energy">ç´¯ç© kJ</option>
      <option value="energy-rate">kJ/km</option>
      <option value="energy-hybrid" selected>ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰</option>
    </select>
  </label>
  <span id="timeBox" class="group" style="display:none"><label>é–“éš” <input id="restMinutes" type="number" value="60" style="width:70px"> åˆ†</label></span>
  <span id="energyBox" class="group"><label>ç´¯ç© <input id="restKJ" type="number" value="500" style="width:90px"> kJ</label><button class="presetKJ" data-kj="400">400</button><button class="presetKJ" data-kj="600">600</button></span>
  <span id="energyRateBox" class="group" style="display:none"><label>ãƒ¬ãƒ¼ãƒˆ <input id="restRateKJ" type="number" value="28" style="width:70px"> kJ/km</label><label>çª“å¹… <input id="rateWindow" type="number" value="500" style="width:70px"> m</label></span>
  <select id="profileSelect"><option value="cycling-road" selected>ãƒ­ãƒ¼ãƒ‰</option><option value="cycling-regular">ä¸€èˆ¬è»Š</option></select>
  <button id="drawBtn">ãƒ«ãƒ¼ãƒˆè¡¨ç¤º</button>
</div>
<div class="section">
  <div class="group"><label>ä½“é‡ <input id="riderWeight" type="number" value="65" style="width:80px"> kg</label><label>ãƒã‚¤ã‚¯ <input id="bikeWeight" type="number" value="10" style="width:80px"> kg</label></div>
  <details><summary>å¹³å¦ä¿‚æ•° (kJ/km)</summary><input id="flatKJperKm" type="number" value="18" style="width:90px"></details>
</div>
<ul id="pointList"></ul>
<ul id="searchResults" hidden></ul>
<div id="map"></div>
<div id="summary"><div id="routeInfo"></div><div id="metricInfo" class="muted"></div></div>
<script defer>
  document.addEventListener('DOMContentLoaded',()=>{
    const ORS_KEY='5b3ce3597851110001cf62481af47799d9c344bf86dd4b340f9f9ff9';
    const ORS='https://api.openrouteservice.org';
    const WAIT=1300,MAX_WP=50,RADII=[800,1600,3000];
    const $=id=>document.getElementById(id);
    const sleep=t=>new Promise(r=>setTimeout(r,t));
    const fmtD=d=>(d/1000).toFixed(2)+' km';
    const fmtT=s=>{const m=Math.round(s/60);return m<60?m+' åˆ†':Math.floor(m/60)+' æ™‚é–“ '+m%60+' åˆ†';};
    const energy=(d,dz,m,f)=>f*(d/1000)+Math.max(dz,0)*m*9.81/1000;
    let pts=[],map,marker,routes={},last=0;
    map=L.map('map').setView([35,135],7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â©OSM'}).addTo(map);
    ['routeShortest','routeFastest','routeSlope'].forEach((p,i)=>map.createPane(p).style.zIndex=690+i*10);
    /* ---- UI Bind ---- */
    $('#searchBtn').onclick=search;
    $('#placeInput').addEventListener('keyup',e=>e.key==='Enter'&&search());
    document.addEventListener('pointerdown',e=>{if(!e.target.closest('#searchResults')&&!e.target.closest('#placeInput'))$('#searchResults').hidden=true;});
    $('#locBtn').onclick=()=>navigator.geolocation.getCurrentPosition(p=>addPt({name:'ç¾åœ¨åœ°',lat:p.coords.latitude,lon:p.coords.longitude}),()=>alert('ä½ç½®å–å¾—å¤±æ•—'));
    $('#drawBtn').onclick=draw;
    $('#restBasis').onchange=toggleBox;
    $('#restModeBtn').onclick=()=>{$('#restToggle').checked=!$('#restToggle').checked;$('#restModeBtn').textContent='ä¼‘æ†©è¾¼ã¿: '+($('#restToggle').checked?'ON':'OFF');};
    document.addEventListener('click',e=>{const b=e.target.closest('.presetKJ');if(b) $('#restKJ').value=b.dataset.kj;});
    new Sortable($('#pointList'),{animation:150,handle:'span',onEnd:()=>{pts=[...$('#pointList').children].map(li=>pts.find(p=>p.name===li.querySelector('span').textContent));fix();}});
    toggleBox();
    /* ---- Functions ---- */
    function toggleBox(){const m=$('#restBasis').value;$('#timeBox').style.display=m==='time'?'inline-flex':'none';$('#energyBox').style.display=/energy/.test(m)?'inline-flex':'none';$('#energyRateBox').style.display=/rate/.test(m)?'inline-flex':'none';}
    async function search(){const q=$('#placeInput').value.trim();if(!q)return;const items=await(await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=10&accept-language=ja&q=${encodeURIComponent(q)}`)).json();const ul=$('#searchResults');ul.innerHTML='';ul.hidden=!items.length;items.forEach(o=>{const li=document.createElement('li');li.textContent=o.display_name;li.onpointerdown=e=>e.stopPropagation();li.onclick=()=>{addPt({name:o.display_name,lat:+o.lat,lon:+o.lon});ul.hidden=true;$('#placeInput').value='';};ul.appendChild(li);});}
    function addPt(p){p.type=pts.length?'':'start';pts.forEach(v=>v.type==='goal'&&(v.type='via'));pts.push(p);pts.length>1&&(pts.at(-1).type='goal');render();}
    function render(){const ul=$('#pointList');ul.innerHTML='';pts.forEach((p,i)=>{const li=document.createElement('li');li.innerHTML=`<span>${p.name}</span>`;const d=document.createElement('button');d.className='del';d.textContent='Ã—';d.onclick=e=>{e.stopPropagation();pts.splice(i,1);fix();render();};li.appendChild(d);ul.appendChild(li);});}
    const fix=()=>{pts[0]&&(pts[0].type='start');pts.length>1&&(pts.at(-1).type='goal');};
    async function ors(body,prof){if(!ORS_KEY){alert('ORSã‚­ãƒ¼æœªè¨­å®š');throw'';}const w=WAIT-(Date.now()-last);if(w>0)await sleep(w);const r=await fetch(`${ORS}/v2/directions/${prof}/geojson`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':ORS_KEY},body:JSON.stringify(body)});last=Date.now();if(!r.ok)throw`ORS ${r.status}`;return r.json();}
    async function poi(lat,lon){for(const r of RADII){const q=`[out:json];(nwr(around:${r},${lat},${lon})[shop]);out center 1;`;try{const d=await(await fetch('https://overpass-api.de/api/interpreter?data='+encodeURIComponent(q))).json();if(d.elements?.length){const e=d.elements[0];return{lat:e.lat||e.center.lat,lon:e.lon||e.center.lon,name:e.tags.name||'ä¼‘æ†©åœ°ç‚¹'};}}catch{}}return{lat,lon,name:'ä¼‘æ†©åœ°ç‚¹'};}
    async function makeRests(base){if(!$('#restToggle').checked)return[];const m=$('#restBasis').value,M=+$('#riderWeight').value+ +$('#bikeWeight').value,f=+$('#flatKJperKm').value,int=+$('#restMinutes').value*60,thrK=+$('#restKJ').value,thrR=+$('#restRateKJ').value,win=+$('#rateWindow').value;const crd=base.geometry.coordinates,ele=crd[0].length>=3;let acc=0,tAcc=0,queue=[],dWin=0,eWin=0,res=[];const reset=()=>{acc=0;tAcc=0;queue=[];dWin=0;eWin=0;};for(const seg of base.properties.segments){for(const st of seg.steps){const [i0,i1]=st.way_points,d=st.distance||0,dz=ele?(crd[i1][2]-crd[i0][2]):0,E=energy(d,dz,M,f);acc+=E;tAcc+=(st.duration||0);queue.push({d,E});dWin+=d;eWin+=E;while(dWin>win&&queue.length){const q=queue.shift();dWin-=q.d;eWin-=q.E;}const rate=dWin?(eWin/1000)/(dWin/1000):0;const hit=(m==='time'&&tAcc>=int)||(m==='energy'&&acc>=thrK)||(m==='energy-rate'&&rate>thrR)||(m==='energy-hybrid'&&(acc>=thrK||rate>thrR));if(hit){const p=await poi(crd[i1][1],crd[i1][0]);res.push({...p,type:'via'});reset();}}}return res;}
    const steepSum=f=>f.properties?.extras?.steepness?.values?.reduce((s,e)=>s+Math.abs(e[2]||0),0)||0;
    async function draw(){try{if(pts.length<2)return alert('2åœ°ç‚¹ä»¥ä¸Š');Object.values(routes).forEach(l=>l&&map.removeLayer(l));routes={};marker&&map.removeLayer(marker);marker=L.featureGroup().addTo(map);const base=await ors({coordinates:[pts[0],pts.at(-1)].map(p=>[p.lon,p.lat]),elevation:true,extra_info:['steepness']},$('#profileSelect').value);const rests=await makeRests(base.features[0]);const merged=[...pts.slice(0,-1),...rests,pts.at(-1)];if(merged.length>MAX_WP){merged.splice(MAX_WP-1);alert('ä¼‘æ†©ã‚’é–“å¼•ãã¾ã—ãŸ');}pts=merged;render();const icon=c=>new L.Icon({iconUrl:`https://maps.gstatic.com/mapfiles/ms2/micons/${c}-dot.png`,iconSize:[32,32],iconAnchor:[16,32]});pts.forEach(p=>marker.addLayer(L.marker([p.lat,p.lon],{icon:icon(p.type==='start'?'green':p.type==='goal'?'red':'blue')}).bindTooltip(p.name)));const profile=$('#profileSelect').value,coords=pts.map(p=>[p.lon,p.lat]);const [shortest,fastest,alts]=await Promise.all([ors({coordinates:coords,preference:'shortest'},profile),ors({coordinates:coords,preference:'fastest'},profile),ors({coordinates:coords,preference:'shortest',alternative_routes:{target_count:3,share_factor:0.6,weight_factor:1.4},elevation:true,extra_info:['steepness']},profile)]);const slope=alts.features.reduce((a,b)=>steepSum(a)<steepSum(b)?a:b);routes.short=L.geoJSON(shortest.features[0],{pane:'routeShortest',style:{color:'#f00',weight:6}}).addTo(map);routes.fast=L.geoJSON(fastest.features[0],{pane:'routeFastest',style:{color:'#06f',weight:6,dashArray:'4 4'}}).addTo(map);routes.slope=L.geoJSON(slope,{pane:'routeSlope',style:{color:'#ff9000',weight:6,opacity:0.9}}).addTo(map);map.fitBounds(marker.getBounds().pad(0.07));$('#routeInfo').innerHTML=`<b>æœ€çŸ­</b> ${fmtD(shortest.features[0].properties.summary.distance)} / ${fmtT(shortest.features[0].properties.summary.duration)}<br><b>æœ€é€Ÿ</b> ${fmtD(fastest.features[0].properties.summary.distance)} / ${fmtT(fastest.features[0].properties.summary.duration)}<br><b>å‹¾é…</b> ${fmtD(slope.properties.summary.distance)} / ${fmtT(slope.properties.summary.duration)}`;}catch(e){console.error(e);alert(e);}}
  });
</script>
</body>
</html>
