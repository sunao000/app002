<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>自転車ルート比較＋自動休憩 v6.1</title>

<link rel="icon" href="data:,">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script  src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script  src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
/* ―― 既存スタイルそのまま ―― */
body{margin:0;font-family:system-ui,sans-serif}
#map{height:500px}
#controls{display:flex;flex-wrap:wrap;gap:8px;padding:8px;background:#f7f7f7}
.section{padding:8px;background:#fff;border-top:1px solid #eee}
.group{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
#searchResults{position:absolute;z-index:1000;width:260px;max-height:200px;overflow-y:auto;margin-top:4px;border:1px solid #ccc;background:#fff;list-style:none;padding:0}
#searchResults li{padding:4px 8px;cursor:pointer}
#searchResults li:hover{background:#e0e0e0}
#pointList{list-style:none;margin:0;padding:0}
#pointList li{display:flex;justify-content:space-between;align-items:center;padding:4px 8px;border:1px solid #ccc;background:#fafafa;margin-bottom:4px;cursor:move}
button.del{background:#d9534f;color:#fff;border:none;border-radius:4px;padding:0 6px;font-size:12px}
#summary{padding:8px;background:#fafafa;border-top:1px solid #ddd;font-size:.9rem}
table.stats{border-collapse:collapse;margin-top:4px}
table.stats th,table.stats td{border:1px solid #ccc;padding:2px 6px;font-size:.8rem;text-align:right}
table.stats th:first-child,table.stats td:first-child{text-align:left}
.legend{display:flex;gap:8px;margin-top:4px;font-size:.8rem}
.legend span{display:inline-flex;align-items:center;gap:4px}
.legend i{width:24px;height:4px;display:inline-block;border:1px solid #000}
</style>
</head>
<body>

<!-- ───── UI（v6.0 と同じ） ───── -->
<div id="controls">
  <input id="placeInput" placeholder="地名・住所" style="width:260px">
  <button id="searchBtn">検索</button>
  <label><input type="checkbox" id="nearbyOnly"> 近くのみ</label>
  <button id="locBtn">現在地追加</button>

  <input id="restToggle" type="checkbox" hidden checked>
  <button id="restModeBtn">休憩込み: ON</button>

  <label>基準
    <select id="restBasis">
      <option value="time" selected>時間</option>
      <option value="energy">kJ</option>
      <option value="energyDiff">kJ/km 変化率</option>
      <option value="energyCombo">Δ＋累積</option>
    </select>
  </label>

  <span id="timeBox"   class="group"><label>間隔 <input id="restMinutes" type="number" value="60" min="15" step="5" style="width:70px"> 分</label></span>
  <span id="energyBox" class="group" style="display:none"><label>しきい値 <input id="restKJ" type="number" value="500" min="100" step="50" style="width:90px"> kJ</label></span>
  <span id="diffBox"   class="group" style="display:none"><label>Δしきい値 <input id="deltaKJ" type="number" value="30" min="1" step="1" style="width:90px"> kJ/km</label></span>

  <select id="profileSelect">
    <option value="cycling-road" selected>ロード</option>
    <option value="cycling-regular">一般車</option>
  </select>

  <button id="drawBtn">ルート表示</button>
  <label><input type="checkbox" id="chkShortest" checked> 最短</label>
  <label><input type="checkbox" id="chkFastest"  checked> 最速</label>
  <label><input type="checkbox" id="chkSlope"    checked> 勾配</label>
</div>

<!-- ライダー設定／その他パネルは v6.0 と同じ -->
<div class="section">
  <div class="group">
    <label>体重 <input id="riderWeight" type="number" value="65" min="30" max="150" step="0.5" style="width:80px"> kg</label>
    <label>バイク <input id="bikeWeight"  type="number" value="10" min="5" max="30" step="0.1" style="width:80px"> kg</label>
  </div>
  <details><summary>平坦係数 (kJ/km)</summary>
    <input id="flatKJperKm" type="number" value="18" min="10" max="30" step="0.5">
  </details>
</div>

<ul id="searchResults" hidden></ul>
<ul id="pointList"></ul>
<div id="map"></div>
<div id="summary">
  <div id="routeInfo"></div>
  <div id="uniformity"></div>
  <div class="legend">
    <span><i style="background:#ff0000"></i>最短</span>
    <span><i style="background:#0066ff;border-style:dashed"></i>最速</span>
    <span><i style="background:#00aa00"></i>勾配</span>
  </div>
</div>

<script>
/* ===== 環境設定 ===== */
const ORS_KEY = '5b3ce3597851110001cf62481af47799d9c344bf86dd4b340f9f9ff9';   // ★置き換え必須

/* CORS プロキシ候補（v6.0 と同じ） */
const PROXIES = [
  '',
  'https://corsproxy.io/?url=',
  'https://cors.isomorphic-git.org/?url=',
  'https://thingproxy.freeboard.io/fetch/'
];
let proxyIdx = 0;

/* ===== ヘルパ ===== */
const $=id=>document.getElementById(id);
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const fmtD=d=>(d/1000).toFixed(2)+' km';
const fmtT=s=>{const m=Math.round(s/60);return m<60?m+' 分':`${Math.floor(m/60)} 時間 ${m%60} 分`;};
const pin=c=>new L.Icon({iconUrl:`https://maps.gstatic.com/mapfiles/ms2/micons/${c}-dot.png`,iconSize:[32,32],iconAnchor:[16,32]});
const ICONS={start:pin('green'),via:pin('blue'),goal:pin('red')};
const near=(g,lat,lon)=>L.latLng(lat,lon).distanceTo([g.lat,g.lon])<=500;

/* ===== 状態 ===== */
let pts=[], map, markerLayer, routeLayers={}, lastTs=0;

/* ===== 初期化（略：v6.0と同じ） ===== */
window.addEventListener('DOMContentLoaded',()=>{
  map=L.map('map').setView([34.07,134.55],11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'©OpenStreetMap'}).addTo(map);
  ['routeShortest','routeFastest','routeSlope'].forEach((p,i)=>map.createPane(p).style.zIndex=700+i*10);
  $('searchBtn').onclick=()=>{const q=$('placeInput').value.trim();q&&search(q);};
  $('locBtn').onclick=addCurrent;
  $('drawBtn').onclick=drawRoutes;
  ['chkShortest','chkFastest','chkSlope'].forEach(id=>$(id).onchange=toggleLayers);
  $('restModeBtn').onclick=()=>{ $('restToggle').checked=!$('restToggle').checked;
    $('restModeBtn').textContent='休憩込み: '+($('restToggle').checked?'ON':'OFF'); drawRoutes(); };
  $('restBasis').onchange=()=>{
    const m=$('restBasis').value;
    $('timeBox').style.display=m==='time'?'inline-flex':'none';
    $('energyBox').style.display=(m==='energy'||m==='energyCombo')?'inline-flex':'none';
    $('diffBox').style.display=(m==='energyDiff'||m==='energyCombo')?'inline-flex':'none';
  };
  new Sortable($('pointList'),{animation:150,handle:'span',
    onEnd:()=>{pts=Array.from($('pointList').children).map(li=>pts[li._idx]);fixType();drawList();}
  });
});

/* ===== 検索 (Nominatim) etc. は v6.0 と同じ ― 省略不可部分のみ変更 ↓ ===== */

/* --- ★ 変更 1: nearPoi を「コンビニ or スーパー」に絞り、距離順で取得 --- */
async function nearPoi(lat,lon){
  try{
    const body={
      request:'pois',
      geometry:{geojson:{type:'Point',coordinates:[lon,lat]},buffer:1500},
      limit:5,
      // 451 = convenience, 518 = supermarket （＋任意で 475:grocery も可）
      filters:{category_ids:[451,518]},
      sortby:'distance'
    };
    const res=await post('https://api.openrouteservice.org/pois',body);
    return res.features[0]||null;
  }catch{return null;}
}
const pName=p=>p?.properties?.name||p?.properties?.osm_tags?.name||'休憩地点';

/* ===== エネルギーモデル eKJ() は変更なし ===== */

/* --- ★ 変更 2: 坂の“前”で休憩を入れるアルゴリズム強化 --- */
async function insertRests(feat,mode){
  const cs=feat.geometry.coordinates, segs=feat.properties.segments, goal=pts.at(-1), elev=cs[0].length>=3;
  const m=+$('riderWeight').value + +$('bikeWeight').value, flat=+$('flatKJperKm').value;

  const deltaEarly=15, Δthr=+$('deltaKJ').value, KJthr=+$('restKJ').value, Tthr=+$('restMinutes').value*60;
  let res=[],bucketΔ=0,bucketDist=0,accKJ=0,accT=0,prevRate=null,flagEarly=false;

  for(const seg of segs)for(const st of seg.steps){
    const [i0,i1]=st.way_points, d=st.distance||0; if(!d)continue;
    const dz=elev?cs[i1][2]-cs[i0][2]:0, Ek=eKJ(d,dz,m,flat), rate=Ek/(d/1000);

    if(prevRate!==null && Math.abs(rate-prevRate)>=deltaEarly) flagEarly=true;

    bucketΔ+=prevRate!==null?Math.abs(rate-prevRate)*(d/1000):0;
    bucketDist+=d/1000; accKJ+=Ek; accT+=st.duration||0;

    const diffAvg=bucketDist?bucketΔ/bucketDist:0, kmHit=bucketDist>=1&&diffAvg>=Δthr;
    const hitTime=mode==='time'&&accT>=Tthr, hitAcc=mode==='energy'&&accKJ>=KJthr;
    const hitDiff=mode==='energyDiff'&&(flagEarly||kmHit);
    const hitComb=mode==='energyCombo'&&(flagEarly||kmHit)&&accKJ>=KJthr;

    if(hitTime||hitAcc||hitDiff||hitComb){
      /* ★坂前ロジック：Δトリガー系なら i0（区間開始点）を基準にする */
      const baseIdx=(flagEarly||kmHit)?i0:i1;
      const [lon,lat]=cs[baseIdx];

      if(near(goal,lat,lon)){bucketΔ=bucketDist=accKJ=accT=0;flagEarly=false;prevRate=rate;continue;}

      let poi=await nearPoi(lat,lon);
      if(!poi)poi={geometry:{coordinates:[lon,lat]},properties:{}};
      res.push({name:pName(poi),lat:poi.geometry.coordinates[1],lon:poi.geometry.coordinates[0],type:'via',isRest:true});

      bucketΔ=bucketDist=accKJ=accT=0;flagEarly=false;
    }
    prevRate=rate;
  }
  pts.splice(pts.length-1,0,...res);
}

/* ===== 以降（drawRoutes, stats, renderUniformity, post, dir など）は v6.0 と同じ ▽ ===== */
/* ── 中略（既存コードをそのまま残す） ── */

/* drawRoutes(), stats(), renderUniformity(), post(), dir(), toggleLayers() は v6.0 と同一 */
/* コード全文を貼り替える場合は、上記「変更 1」「変更 2」部分だけを差し替えれば動作します */
</script>
</body>
</html>
