<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ルート設計ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    #map { height: 80vh; }
    ul { list-style-type: none; padding: 0; }
    li { padding: 4px; background: #eee; margin: 2px; cursor: move; }
  </style>
</head>
<body>

<h2>マニュアルルート設計ツール</h2>
<div id="map"></div>

<ul id="pointsList"></ul>
<button id="routeBtn">ルート表示</button>
<button id="googleMapsBtn">Google Mapsで開く</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/sortablejs@1.14.0/Sortable.min.js"></script>

<script>
const map = L.map('map').setView([34.0703, 134.5594], 13); // 徳島周辺
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markers = [];
let points = [];

map.on('click', async (e) => {
  const lat = e.latlng.lat;
  const lng = e.latlng.lng;

  // 地名取得（Nominatim）
  const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
  const data = await res.json();
  const name = data.display_name || `(${lat.toFixed(5)}, ${lng.toFixed(5)})`;

  const marker = L.marker([lat, lng]).addTo(map).bindPopup(name);
  markers.push(marker);
  points.push({ lat, lng, name });

  updatePointList();
});

function updatePointList() {
  const list = document.getElementById('pointsList');
  list.innerHTML = '';

  points.forEach((pt, index) => {
    const li = document.createElement('li');
    li.textContent = pt.name;
    li.setAttribute('data-id', index);
    list.appendChild(li);
  });

  // 並び替え機能（Sortable.js）
  Sortable.create(list, {
    onEnd: function (evt) {
      const newPoints = [];
      const items = list.querySelectorAll('li');
      items.forEach(item => {
        const id = parseInt(item.getAttribute('data-id'));
        newPoints.push(points[id]);
      });
      points = newPoints;
    }
  });
}

// OpenRouteService でルート表示
document.getElementById('routeBtn').addEventListener('click', async () => {
  if (points.length < 2) {
    alert('2点以上の地点を選んでください');
    return;
  }

  const coords = points.map(p => [p.lng, p.lat]);

  const res = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
    method: 'POST',
    headers: {
      'Authorization': 'あなたのORS_APIキー', // ← OpenRouteService の API キーを入力
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ coordinates: coords })
  });

  const data = await res.json();

  // 古いルートを削除
  if (window.routeLayer) {
    map.removeLayer(window.routeLayer);
  }

  window.routeLayer = L.geoJSON(data, {
    style: { color: 'blue', weight: 5 }
  }).addTo(map);

  map.fitBounds(window.routeLayer.getBounds());
});

// Google Maps で同じ順番で開く
document.getElementById('googleMapsBtn').addEventListener('click', () => {
  if (points.length < 2) {
    alert('地点が2つ以上必要です');
    return;
  }

  const start = `${points[0].lat},${points[0].lng}`;
  const end = `${points[points.length - 1].lat},${points[points.length - 1].lng}`;
  const waypoints = points.slice(1, -1).map(p => `${p.lat},${p.lng}`).join('|');

  let gmapUrl = `https://www.google.com/maps/dir/?api=1&origin=${start}&destination=${end}`;
  if (waypoints) {
    gmapUrl += `&waypoints=${encodeURIComponent(waypoints)}`;
  }

  window.open(gmapUrl, '_blank');
});
</script>

</body>
</html>
