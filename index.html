<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>自転車ルート比較＋自動休憩（PNG 出力版）v5.3</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{margin:0;font-family:system-ui,sans-serif}
    #map{height:500px;width:100%}
    #controls{display:flex;flex-wrap:wrap;gap:8px;padding:8px;background:#f7f7f7}
    #pointList{list-style:none;margin:0;padding:0}
    #pointList li{display:flex;align-items:center;justify-content:space-between;padding:4px 8px;border:1px solid #ccc;background:#fafafa;margin-bottom:4px;cursor:move}
    button.del{background:#d9534f;color:#fff;border:none;border-radius:4px;padding:0 6px;font-size:12px}
    #searchResults{position:absolute;z-index:1000;width:260px;max-height:200px;overflow-y:auto;margin:4px 0 0;padding:0;
      list-style:none;border:1px solid #ccc;background:#fff}
    #searchResults li{padding:4px 8px;cursor:pointer}
    #searchResults li:hover{background:#e0e0e0}
    #summary{padding:8px;background:#fafafa;border-top:1px solid #ddd;font-size:0.9rem}
    .legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:4px;font-size:0.8rem}
    .legend-item{display:flex;align-items:center;gap:4px}
    .legend-color{width:14px;height:14px;border-radius:3px}
    .section{padding:8px;background:#fff;border-top:1px solid #eee}
    .group{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .muted{color:#666;font-size:0.85em}
    .presetKJ{border:1px solid #ccc;border-radius:14px;padding:2px 8px;font-size:.85em;background:#fff;cursor:pointer}
    .presetKJ:hover{background:#f0f0f0}
    details{border:1px solid #ddd;border-radius:6px;padding:6px;background:#fff}
    /* チャートは画面には出さない */
    #charts{display:none}
    #charts canvas{width:800px;height:400px}
  </style>
</head>
<body>

<!-- ────────── UI ────────── -->
<div id="controls">
  <input id="placeInput" placeholder="地名・住所" style="width:260px" />
  <button id="searchBtn">検索</button>
  <label><input type="checkbox" id="nearbyOnly" /> 近くの場所のみ</label>
  <button id="locBtn">現在地追加</button>

  <input id="restToggle" type="checkbox" checked hidden />
  <button id="restModeBtn">休憩込み: ON</button>

  <!-- ★ 新トグル -->
  <label><input type="checkbox" id="downloadGraphs" /> グラフを PNG 保存</label>

  <label>基準
    <select id="restBasis">
      <option value="time">時間</option>
      <option value="energy" selected>kJ</option>
    </select>
  </label>

  <span id="timeBox" class="group" style="display:none">
    <label>間隔 <input id="restMinutes" type="number" value="60" min="15" step="5" style="width:70px" /> 分</label>
  </span>
  <span id="energyBox" class="group">
    <label>しきい値 <input id="restKJ" type="number" value="500" min="100" step="50" style="width:90px" /> kJ</label>
    <button type="button" class="presetKJ" data-kj="400">400</button>
    <button type="button" class="presetKJ" data-kj="500">500</button>
    <button type="button" class="presetKJ" data-kj="650">650</button>
  </span>

  <select id="profileSelect">
    <option value="cycling-road" selected>ロードバイク</option>
    <option value="cycling-regular">自転車（一般）</option>
  </select>
  <button id="drawBtn">ルート表示</button>

  <label><input type="checkbox" id="chkShortest" checked /> 最短</label>
  <label><input type="checkbox" id="chkFastest" checked /> 最速</label>
  <label><input type="checkbox" id="chkSlope" checked /> 勾配</label>
</div>

<!-- パラメータ設定・地図・サマリーは v5.2 と同じ（省略） -->

<!-- オフスクリーン描画用コンテナ -->
<div id="charts">
  <canvas id="energyChart"></canvas>
  <canvas id="rateChart"></canvas>
</div>

<script>
/* ===== 定数・ヘルパ（v5.2 と同） ===== */
const ORS_KEY='';              // ← API キー
const ORS_ROOT='https://api.openrouteservice.org';
/* ……（略：ヘルパ関数や初期化は従来と同じ） …… */

/* ===== グラフ → PNG ダウンロード ===== */
function buildChart(ctx,type,labels,data,labelTxt){
  return new Chart(ctx,{
    type,
    data:{labels,datasets:[{label:labelTxt,data,borderWidth:2,pointRadius:0}]},
    options:{animation:false,plugins:{legend:{display:false}},scales:{x:{title:{display:true,text:'距離 (km)'}},
            y:{title:{display:true,text:labelTxt}}}}
  });
}

function downloadCanvasPNG(canvas, filename){
  canvas.toBlob(blob=>{
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=filename; a.style.display='none';
    document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},1000);
  },'image/png');
}

function downloadEnergyGraphs(feature,mass,flatKJperKm){
  /* ---- データ生成 ---- */
  const coords=feature.geometry.coordinates, hasEle=coords[0].length>=3;
  let cumE=0,cumD=0,km=[],kj=[],rate=[];
  for(let i=1;i<coords.length;i++){
    const [lon,lat,ele]=coords[i], [plon,plat,pele]=coords[i-1];
    const d=L.latLng(lat,lon).distanceTo([plat,plon]), dz=hasEle?((ele||0)-(pele||0)):0;
    cumD+=d; cumE+=energyStepKJ(d,dz,mass,flatKJperKm);
    km.push((cumD/1000).toFixed(2)); kj.push(cumE.toFixed(1));
  }
  /* 区間エネルギーレート(kJ/km) */
  for(let i=1;i<km.length;i++){
    const dk=kj[i]-kj[i-1], dd=km[i]-km[i-1];
    rate.push((dk/dd).toFixed(2));
  }
  rate.unshift(rate[0]);           // 配列長合わせ

  /* ---- オフスクリーン描画 ---- */
  const ec=$('energyChart'), rc=$('rateChart');
  const ch1=buildChart(ec,'line',km,kj,'累積エネルギー (kJ)');
  const ch2=buildChart(rc,'bar',km,rate,'kJ/km');

  /* ---- PNG ダウンロード ---- */
  downloadCanvasPNG(ec,'energy_profile.png');
  downloadCanvasPNG(rc,'energy_rate.png');

  /* ---- 後片付け ---- */
  setTimeout(()=>{ch1.destroy();ch2.destroy();},50);
}

/* ===== drawRoutes 末尾に追記 ===== */
/* 省略 … ルート取得 / サマリー表示が終わった直後 */

const save = $('downloadGraphs').checked;
if(save){
  const mass=Number($('riderWeight').value||65)+Number($('bikeWeight').value||9);
  downloadEnergyGraphs(fastest.features[0],mass,Number($('flatKJperKm').value||18));
}

</script>
</body>
</html>
