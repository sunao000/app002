<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ルート検索と地図表示</title>
  <style>
    #map {
      width: 100%;
      height: 500px;
      margin-top: 10px;
    }
    #locationList li {
      margin: 5px 0;
    }
  </style>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2GgfHkSDBYzrY9F7YAWp6V8sFZpMQuzH8mG0kEQ="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1jRVvXCn/7nVvP7jN1cUlACjOqsnnt50eH5/Tr1s="
    crossorigin=""
  ></script>
</head>
<body>
  <h1>ルート検索と地図表示</h1>
  <label>
    <input type="checkbox" id="locationFilterToggle" checked />
    近くの場所のみに制限
  </label><br /><br />
  <input id="placeInput" type="text" placeholder="地名を入力" />
  <button onclick="searchPlace()">検索して追加</button>
  <button onclick="addCurrentLocation()">現在地を追加</button>
  <button onclick="showRoute()">ルート検索</button>
  <ul id="locationList"></ul>
  <div id="map"></div>

  <script>
    let locationList = [];
    let locationFilterEnabled = true;
    let currentPosition = null;
    let map = L.map("map").setView([35.681236, 139.767125], 10);
    let markers = [];
    let routePolyline = null;

    // 地図タイルを追加
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
    }).addTo(map);

    // 近くの場所のみに制限切り替え
    document.getElementById("locationFilterToggle").addEventListener("change", (e) => {
      locationFilterEnabled = e.target.checked;
    });

    // 現在地のリアルタイム取得
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        (position) => {
          currentPosition = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };
        },
        (err) => {
          console.error("位置情報の取得に失敗:", err);
        },
        { enableHighAccuracy: true }
      );
    }

    // 地名を検索して追加
    async function searchPlace() {
      const place = document.getElementById("placeInput").value;
      if (!place) return;
      let url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(place)}&format=json`;

      if (locationFilterEnabled && currentPosition) {
        url += `&viewbox=${currentPosition.lng - 0.05},${currentPosition.lat + 0.05},${currentPosition.lng + 0.05},${currentPosition.lat - 0.05}&bounded=1`;
      }

      const response = await fetch(url);
      const results = await response.json();

      if (results.length > 0) {
        const first = results[0];
        addLocation({ name: first.display_name, lat: parseFloat(first.lat), lng: parseFloat(first.lon) });
      } else {
        alert("地名が見つかりませんでした");
      }
    }

    // 現在地を地点として追加
    function addCurrentLocation() {
      if (!currentPosition) {
        alert("現在地がまだ取得されていません。少し待ってください。");
        return;
      }

      const name = `現在地（${currentPosition.lat.toFixed(5)}, ${currentPosition.lng.toFixed(5)}）`;
      addLocation({ name, lat: currentPosition.lat, lng: currentPosition.lng });
    }

    // 地点をリストに追加
    function addLocation(loc) {
      locationList.push(loc);
      renderLocationList();
      updateMapMarkers();
    }

    // 地点を削除
    function removeLocation(index) {
      locationList.splice(index, 1);
      renderLocationList();
      updateMapMarkers();
    }

    // 地点リストを表示（出発地・経由地・目的地）
    function renderLocationList() {
      const ul = document.getElementById("locationList");
      ul.innerHTML = "";

      locationList.forEach((loc, index) => {
        let label = "経由地";
        if (index === 0) label = "出発地";
        else if (index === locationList.length - 1) label = "目的地";

        const li = document.createElement("li");
        li.innerHTML = `${label}: ${loc.name} <button onclick="removeLocation(${index})">削除</button>`;
        ul.appendChild(li);
      });
    }

    // 地図上のマーカー更新
    function updateMapMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      locationList.forEach(loc => {
        const marker = L.marker([loc.lat, loc.lng]).addTo(map).bindPopup(loc.name);
        markers.push(marker);
      });
      if (locationList.length > 0) {
        map.setView([locationList[0].lat, locationList[0].lng], 12);
      }
    }

    // 地図にルート線を表示
    function showRoute() {
      if (routePolyline) {
        map.removeLayer(routePolyline);
      }

      if (locationList.length < 2) {
        alert("ルート検索には最低2地点が必要です。");
        return;
      }

      const latlngs = locationList.map(loc => [loc.lat, loc.lng]);
      routePolyline = L.polyline(latlngs, { color: 'blue' }).addTo(map);
      map.fitBounds(routePolyline.getBounds());
    }
  </script>
</body>
</html>
