<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>自転車ルート比較＋休憩（トリガ併用版） v6.0</title>

<!-- ライブラリ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:system-ui,sans-serif}
#map{height:500px;width:100%}
#controls{display:flex;flex-wrap:wrap;gap:8px;padding:8px;background:#f7f7f7}
#pointList{list-style:none;margin:0;padding:0}
#pointList li{display:flex;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;padding:4px 8px;border:1px solid #ccc;background:#fafafa;margin-bottom:4px;cursor:move}
button.del{background:#d9534f;color:#fff;border:none;border-radius:4px;padding:0 6px;font-size:12px}
#searchResults{position:absolute;z-index:1000;width:260px;max-height:200px;overflow-y:auto;margin:4px 0 0;padding:0;list-style:none;border:1px solid #ccc;background:#fff}
#searchResults li{padding:4px 8px;cursor:pointer}
#searchResults li:hover{background:#e0e0e0}
#summary{padding:8px;background:#fafafa;border-top:1px solid #ddd;font-size:0.9rem}
.section{padding:8px;background:#fff;border-top:1px solid #eee}
.group{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:6px}
.small{font-size:.88em;color:#555}
details{border:1px solid #ddd;border-radius:6px;padding:6px;background:#fff}
#charts{display:none}
#charts canvas{width:800px;height:400px}
hr{border:none;border-top:1px solid #eee;margin:8px 0}
label.chk{display:inline-flex;align-items:center;gap:6px;margin-right:10px}
input[type=number]{width:90px}
th,td{font-size:0.92rem}
#finalRoutes button{margin:4px;padding:4px 8px}
</style>
</head>
<body>

<!-- ────────── 上部操作 ────────── -->
<div id="controls">
  <input id="placeInput" placeholder="地名・住所" style="width:260px">
  <button id="searchBtn">検索</button>
  <label><input type="checkbox" id="nearbyOnly"> 近くの場所のみ</label>
  <button id="locBtn">現在地追加</button>

  <input id="restToggle" type="checkbox" checked hidden>
  <button id="restModeBtn">休憩込み: ON</button>

  <button id="btnDownloadTime"  disabled>PNG（時間×累積kJ）</button>
  <button id="btnDownloadDist"  disabled>PNG（距離×累積kJ）</button>

  <label>基準
    <select id="restBasis">
      <option value="time">時間</option>
      <option value="energy" selected>kJ</option>
    </select>
  </label>

  <span id="timeBox" class="group" style="display:none">
    <label>間隔 <input id="restMinutes" type="number" value="60" min="15" step="5"> 分</label>
  </span>
  <span id="energyBox" class="group">
    <label>しきい値 <input id="restKJ" type="number" value="500" min="100" step="50"> kJ</label>
    <button type="button" class="presetKJ" data-kj="400">400</button>
    <button type="button" class="presetKJ" data-kj="500">500</button>
    <button type="button" class="presetKJ" data-kj="650">650</button>
  </span>

  <select id="profileSelect">
    <option value="cycling-road" selected>ロードバイク</option>
    <option value="cycling-regular">自転車（一般）</option>
  </select>
  <button id="drawBtn">ルート表示</button>

  <label><input type="checkbox" id="chkShortest" checked> 最短</label>
  <label><input type="checkbox" id="chkFastest" checked> 最速</label>
  <label><input type="checkbox" id="chkSlope" checked> 勾配</label>
</div>

<!-- ────────── 休憩地点まわりのPOI設定 ────────── -->
<div class="section">
  <details open>
    <summary>休憩地点まわりのPOI</summary>
    <div class="group">
      <label class="chk"><input type="checkbox" id="poiToggle"> POIを表示する</label>
      <label>半径 <input id="poiRadius" type="number" value="300" min="50" step="50"> m</label>
      <label>候補数 <input id="poiCount" type="number" value="3" min="1" max="10"> 件</label>
    </div>
    <div class="group">
      <label class="chk"><input type="checkbox" class="poiCat" value="conv" checked> コンビニ</label>
      <label class="chk"><input type="checkbox" class="poiCat" value="super"> スーパー</label>
      <label class="chk"><input type="checkbox" class="poiCat" value="drug"> ドラッグストア</label>
    </div>
  </details>
</div>

<!-- ────────── 休憩ロジック設定 ────────── -->
<div class="section">
  <div class="group">
    <label>体重 <input id="riderWeight" type="number" value="65" min="30" max="150" step="0.5"> kg</label>
    <label>バイク重量 <input id="bikeWeight" type="number" value="10" min="5" max="30" step="0.1"> kg</label>
  </div>
  <details open><summary>積算トリガ（時間/kJ）</summary>
    <div class="group">
      <label class="chk"><input type="checkbox" id="optAccum" checked> 積算トリガを使う</label>
      <span class="small">※ 上の「基準」と「しきい値/間隔」設定を使用</span>
    </div>
  </details>
  <details open><summary>統計トリガ</summary>
    <div class="group">
      <label class="chk"><input type="checkbox" id="optStatTrigger"> 統計トリガを使う</label>
    </div>
    <div class="group">
      <label>指標
        <select id="statMetric">
          <option value="distance" selected>走行距離（km）</option>
          <option value="energy">消費エネルギー（kJ）</option>
        </select>
      </label>
      <label>平均 <input id="statMean" type="number" value="20"> km</label>
      <label>分散 <input id="statVar" type="number" value="9"> km²</label>
      <label>下限 <input id="statMin" type="number" value="5"> km</label>
    </div>
    <div class="group">
      <label>乱数シード <input id="statSeed" type="number" value="12345"></label>
      <button type="button" id="statResampleBtn">次のターゲットを再サンプル</button>
    </div>
  </details>
  <details><summary>詳細設定</summary>
    <div class="small">平坦係数 (kJ/km)</div>
    <label>平坦係数 <input id="flatKJperKm" type="number" value="18" min="10" max="30" step="0.5"> kJ/km</label>
  </details>
</div>

<ul id="searchResults" hidden></ul>
<ul id="pointList"></ul>
<div id="map"></div>

<div id="summary">
  <div id="routeInfo"></div>
  <div id="distanceScore" class="muted"></div>
</div>

<!-- 区間集計 -->
<div class="section">
  <details open>
    <summary>区間集計</summary>
    <div class="group">
      <label>指標
        <select id="legMetric">
          <option value="distance" selected>距離（km）</option>
          <option value="energy">エネルギー（kJ）</option>
        </select>
      </label>
      <label class="chk"><input type="checkbox" id="legIncludeRest" checked> 休憩地点を含める</label>
      <button type="button" id="btnCalcLegs">再計算</button>
    </div>
    <div class="small" id="legSummary">未計算</div>
    <div style="overflow:auto; max-height:240px;">
      <table id="legTable" style="border-collapse:collapse; width:100%;">
        <thead>
          <tr>
            <th>#</th><th>区間</th><th style="text-align:right;">距離 (km)</th><th style="text-align:right;">エネルギー (kJ)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </details>
</div>

<!-- 最終候補ルート表示 -->
<div class="section">
  <details open>
    <summary>最終候補ルート（上位3件）</summary>
    <div class="group">
      <label>評価指標
        <select id="finalMetric">
          <option value="distance">距離</option>
          <option value="time">時間</option>
          <option value="energy">エネルギー</option>
        </select>
      </label>
      <button id="btnFinalRoutes">候補ルート計算</button>
    </div>
    <div id="finalRoutes" class="small"></div>
  </details>
</div>

<!-- デバッグ -->
<div class="section">
  <details open>
    <summary>休憩トリガ・ヒット状況</summary>
    <div id="restDebug" class="small"></div>
  </details>
</div>

<!-- グラフ -->
<div id="charts">
  <canvas id="energyChart"></canvas>
</div>

<script>
/* ここに既存v5.9.2の全JSロジックを入れつつ、以下の関数を追加 */

/* === 新規追加：休憩地点POI候補収集 === */
async function collectRestPOICandidates(restPts, cats, radius, maxCount){
  for (const rp of restPts){
    rp.pois = (await fetchPoisAround(rp.lat, rp.lon, radius, cats)).slice(0, maxCount);
  }
}

/* === 新規追加：休憩POI全組み合わせ生成 === */
function buildCombos(restPts){
  const arrays = restPts.map(rp => rp.pois);
  return arrays.reduce((acc,cur)=>acc.flatMap(a=>cur.map(c=>[...a,c])), [[]]);
}

/* === 新規追加：ORSで組み合わせ評価 === */
async function evaluateCombo(start, goal, comboPOIs, profile, mass, flat){
  const coords = [start, ...comboPOIs, goal].map(p=>[p.lon,p.lat]);
  const res = await dir({coordinates:coords,elevation:true,extra_info:['steepness']}, profile);
  const f = res.features[0];
  const dist = f.properties.summary.distance/1000;
  const time = f.properties.summary.duration/60;
  let energy = 0;
  const { segD, segDZ } = deriveSeriesFromCoords(f);
  for (let i=0;i<segD.length;i++) energy += energyStepKJ(segD[i], segDZ[i], mass, flat);
  return {feature:f, distance:dist, time:time, energy:energy};
}

/* === 新規追加：ランキング === */
function rankRoutes(results, metric){
  return results.sort((a,b)=>a[metric]-b[metric]).slice(0,3);
}

/* === 新規追加：上位候補リスト描画 === */
function renderFinalRouteList(routes){
  const div = document.getElementById('finalRoutes');
  div.innerHTML = '';
  routes.forEach((r,i)=>{
    const btn = document.createElement('button');
    btn.textContent = `候補${i+1}: 距${r.distance.toFixed(1)}km / 時${r.time.toFixed(1)}分 / エ${r.energy.toFixed(0)}kJ`;
    btn.onclick = ()=>{
      if(routeLayers.final) map.removeLayer(routeLayers.final);
      routeLayers.final = L.geoJSON(r.feature,{color:'#00cc88',weight:6}).addTo(map);
      map.fitBounds(routeLayers.final.getBounds());
    };
    div.appendChild(btn);
  });
}

/* === ボタン動作 === */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('btnFinalRoutes').onclick = async ()=>{
    const profile = document.getElementById('profileSelect').value;
    const mass = Number(document.getElementById('riderWeight').value)+Number(document.getElementById('bikeWeight').value);
    const flat = Number(document.getElementById('flatKJperKm').value);
    const metric = document.getElementById('finalMetric').value;
    const cats = Array.from(document.querySelectorAll('.poiCat:checked')).map(x=>x.value);
    const radius = Number(document.getElementById('poiRadius').value)||300;
    const maxCnt = Number(document.getElementById('poiCount').value)||3;
    const restPts = pts.filter(p=>p.isRest);
    if(!restPts.length){ alert('休憩地点がありません'); return; }
    await collectRestPOICandidates(restPts, cats, radius, maxCnt);
    const combos = buildCombos(restPts);
    const results = [];
    for(const combo of combos){
      const r = await evaluateCombo(pts[0], pts[pts.length-1], combo, profile, mass, flat);
      results.push(r);
      await sleep(1200); // ORSレート制限
    }
    const top3 = rankRoutes(results, metric);
    renderFinalRouteList(top3);
  };
});
</script>

</body>
</html>
