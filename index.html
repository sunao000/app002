<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ルート検索マップ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    #map {
      height: 90vh;
      width: 100%;
    }
    .controls {
      margin: 10px;
    }
  </style>
</head>
<body>
  <div class="controls">
    APIキー: <input type="text" id="apiKey" size="40" />
    移動手段:
    <select id="profile">
      <option value="driving-car">自動車</option>
      <option value="cycling-regular">自転車</option>
      <option value="foot-walking">徒歩</option>
    </select>
    <button onclick="getRoute()">ルート検索</button>
    <button onclick="clearMap()">すべてクリア</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([35.681236, 139.767125], 13); // 東京駅
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
    }).addTo(map);

    const profileSelect = document.getElementById('profile');
    const apiKeyInput = document.getElementById('5b3ce3597851110001cf62481af47799d9c344bf86dd4b340f9f9ff9');

    let markers = [];
    let points = []; // {lat, lng, role}
    let routeLayer = null;

    const roleColors = {
      start: 'green',
      via: 'blue',
      end: 'red',
    };

    map.on('click', function (e) {
      const role = prompt('地点の役割を入力してください（start / via / end）:');
      if (!['start', 'via', 'end'].includes(role)) {
        alert('無効な入力です。start / via / end のいずれかを入力してください。');
        return;
      }

      // start や end は1つまで
      if (role === 'start') {
        removeExistingMarker('start');
      } else if (role === 'end') {
        removeExistingMarker('end');
      }

      const marker = L.circleMarker(e.latlng, {
        radius: 8,
        fillColor: roleColors[role],
        color: '#000',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8,
      }).addTo(map).bindPopup(`${role === 'start' ? '出発地' : role === 'end' ? '目的地' : '経由地'}`).openPopup();

      markers.push(marker);
      points.push({ lat: e.latlng.lat, lng: e.latlng.lng, role });
    });

    function removeExistingMarker(role) {
      const index = points.findIndex(p => p.role === role);
      if (index !== -1) {
        const marker = markers[index];
        map.removeLayer(marker);
        points.splice(index, 1);
        markers.splice(index, 1);
      }
    }

    function getRoute() {
      const apiKey = apiKeyInput.value;
      const profile = profileSelect.value;

      if (!apiKey) {
        alert('APIキーを入力してください。');
        return;
      }

      const start = points.find(p => p.role === 'start');
      const end = points.find(p => p.role === 'end');
      const vias = points.filter(p => p.role === 'via');

      if (!start || !end) {
        alert('出発地と目的地を設定してください。');
        return;
      }

      const ordered = [start, ...vias, end];
      const coordinates = ordered.map(p => [p.lng, p.lat]);

      fetch(`https://api.openrouteservice.org/v2/directions/${profile}`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json, application/geo+json',
          'Content-Type': 'application/json',
          'Authorization': apiKey,
        },
        body: JSON.stringify({ coordinates }),
      })
        .then(response => {
          if (!response.ok) return response.text().then(text => { throw new Error(text); });
          return response.json();
        })
        .then(data => {
          if (routeLayer) map.removeLayer(routeLayer);
          routeLayer = L.geoJSON(data, {
            style: { color: 'orange', weight: 5 },
          }).addTo(map);
        })
        .catch(error => {
          console.error(error);
          alert('ルート取得に失敗しました: ' + error.message);
        });
    }

    function clearMap() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      points = [];
      if (routeLayer) {
        map.removeLayer(routeLayer);
        routeLayer = null;
      }
    }
  </script>
</body>
</html>
