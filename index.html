<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>è‡ªè»¢è»Šãƒ«ãƒ¼ãƒˆæ¯”è¼ƒï¼‹è‡ªå‹•ä¼‘æ†© PNG å‡ºåŠ› v5.7.0</title>

<!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script  src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script  src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script  src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:system-ui,sans-serif}
#map{height:500px;width:100%}
#controls{display:flex;flex-wrap:wrap;gap:8px;padding:8px;background:#f7f7f7}
#pointList{list-style:none;margin:0;padding:0}
#pointList li{display:flex;flex-direction:column;gap:2px;padding:6px 8px;border:1px solid #ccc;background:#fafafa;margin-bottom:4px;cursor:move}
#pointList li .row{display:flex;align-items:center;justify-content:space-between}
#pointList li .sub{font-size:.85em;color:#666}
button.del{background:#d9534f;color:#fff;border:none;border-radius:4px;padding:0 6px;font-size:12px}
#searchResults{position:absolute;z-index:1000;width:260px;max-height:200px;overflow-y:auto;margin:4px 0 0;padding:0;list-style:none;border:1px solid #ccc;background:#fff}
#searchResults li{padding:4px 8px;cursor:pointer}
#searchResults li:hover{background:#e0e0e0}
#summary{padding:8px;background:#fafafa;border-top:1px solid #ddd;font-size:0.9rem}
.section{padding:8px;background:#fff;border-top:1px solid #eee}
.group{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.muted{color:#666;font-size:0.85em}
.presetKJ{border:1px solid #ccc;border-radius:14px;padding:2px 8px;font-size:.85em;background:#fff;cursor:pointer}
.presetKJ:hover{background:#f0f0f0}
#charts{display:none}
#charts canvas{width:800px;height:400px}
.cat-group{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
.cat-group label{display:flex;align-items:center;gap:6px;border:1px solid #ddd;border-radius:16px;padding:4px 8px;background:#fff}
.badge{font-weight:600}
</style>
</head>
<body>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…¥åŠ› UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="controls">
  <input id="placeInput" placeholder="åœ°åãƒ»ä½æ‰€" style="width:260px">
  <button id="searchBtn">æ¤œç´¢</button>
  <label><input type="checkbox" id="nearbyOnly"> è¿‘ãã®å ´æ‰€ã®ã¿</label>
  <button id="locBtn">ç¾åœ¨åœ°è¿½åŠ </button>

  <input id="restToggle" type="checkbox" checked hidden>
  <button id="restModeBtn">ä¼‘æ†©è¾¼ã¿: ON</button>

  <button id="btnDownloadTime"  disabled>ã‚°ãƒ©ãƒ• PNGï¼ˆæ™‚é–“Ã—ç´¯ç©kJï¼‰</button>
  <button id="btnDownloadDist"  disabled>ã‚°ãƒ©ãƒ• PNGï¼ˆè·é›¢Ã—ç´¯ç©kJï¼‰</button>

  <label>åŸºæº–
    <select id="restBasis">
      <option value="time">æ™‚é–“</option>
      <option value="energy" selected>kJ</option>
    </select>
  </label>

  <span id="timeBox" class="group" style="display:none">
    <label>é–“éš” <input id="restMinutes" type="number" value="60" min="15" step="5" style="width:70px"> åˆ†</label>
  </span>
  <span id="energyBox" class="group">
    <label>ã—ãã„å€¤ <input id="restKJ" type="number" value="500" min="100" step="50" style="width:90px"> kJ</label>
    <button type="button" class="presetKJ" data-kj="400">400</button>
    <button type="button" class="presetKJ" data-kj="500">500</button>
    <button type="button" class="presetKJ" data-kj="650">650</button>
  </span>

  <select id="profileSelect">
    <option value="cycling-road" selected>ãƒ­ãƒ¼ãƒ‰ãƒã‚¤ã‚¯</option>
    <option value="cycling-regular">è‡ªè»¢è»Šï¼ˆä¸€èˆ¬ï¼‰</option>
  </select>
  <button id="drawBtn">ãƒ«ãƒ¼ãƒˆè¡¨ç¤º</button>

  <label><input type="checkbox" id="chkShortest" checked> æœ€çŸ­</label>
  <label><input type="checkbox" id="chkFastest" checked> æœ€é€Ÿ</label>
  <label><input type="checkbox" id="chkSlope" checked> å‹¾é…</label>
</div>

<div class="section">
  <div class="group">
    <label>ä½“é‡ <input id="riderWeight" type="number" value="65" min="30" max="150" step="0.5" style="width:80px"> kg</label>
    <label>ãƒã‚¤ã‚¯é‡é‡ <input id="bikeWeight" type="number" value="10" min="5" max="30" step="0.1" style="width:80px"> kg</label>
  </div>

  <!-- ä¼‘æ†©ã‚«ãƒ†ã‚´ãƒªã®ON/OFF -->
  <div class="group">
    <div class="muted">ä¼‘æ†©å€™è£œã‚«ãƒ†ã‚´ãƒª</div>
    <div class="cat-group">
      <label><input type="checkbox" id="catConv"  checked> ã‚³ãƒ³ãƒ“ãƒ‹</label>
      <label><input type="checkbox" id="catMichi" checked> é“ã®é§…</label>
      <label><input type="checkbox" id="catSuper" checked> ã‚¹ãƒ¼ãƒ‘ãƒ¼</label>
      <label><input type="checkbox" id="catDrug"  checked> ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢</label>
    </div>
  </div>

  <details><summary>è©³ç´°è¨­å®šï¼ˆç°¡æ˜“ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒ¢ãƒ‡ãƒ«ï¼‰</summary>
    <div class="muted">å¹³å¦ä¿‚æ•° (kJ/km)</div>
    <label>å¹³å¦ä¿‚æ•° <input id="flatKJperKm" type="number" value="18" min="10" max="30" step="0.5" style="width:90px"> kJ/km</label>
  </details>
</div>

<ul id="searchResults" hidden></ul>
<ul id="pointList"></ul>
<div id="map"></div>

<div id="summary">
  <div id="routeInfo"></div>
  <div id="distanceScore" class="muted"></div>
</div>

<!-- ç”»åƒåŒ–ç”¨ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->
<div id="charts">
  <canvas id="energyChart"></canvas>
</div>

<script>
/* ===== å®šæ•° ===== */
const ORS_KEY  = '5b3ce3597851110001cf62481af47799d9c344bf86dd4b340f9f9ff9';  // å¿…è¦ãªã‚‰è¨­å®š
const ORS_ROOT = 'https://api.openrouteservice.org';

/* POIå–å¾—ï¼ˆOverpassï¼‰ */
const OVERPASS_URL = 'https://overpass-api.de/api/interpreter';
const RADII    = [800,1500,2500];
const CLOSE_TO_GOAL_M = 500;

/* ===== ãƒ˜ãƒ«ãƒ‘ ===== */
const $ = id=>document.getElementById(id);
const sleep = ms=>new Promise(r=>setTimeout(r,ms));

const iconUrl = c => `https://maps.gstatic.com/mapfiles/ms2/micons/${c}-dot.png`;
const icon  = c=>new L.Icon({iconUrl:iconUrl(c),iconSize:[32,32],iconAnchor:[16,32]});
const ICONS = {start:icon('green'),via:icon('blue'),goal:icon('red'),rest:icon('yellow')};

const formatDist = d=>(d/1000).toFixed(2)+' km';
const formatDur  = s=>{const m=Math.round(s/60);return m<60?`${m} åˆ†`:`${Math.floor(m/60)} æ™‚é–“ ${m%60} åˆ†`;};
const steepSum   = f=>(f.properties.extras.steepness.values||[]).reduce((s,e)=>s+Math.abs(e[2]||0),0);

const havDist = (lat1,lon1,lat2,lon2)=>{
  const R=6371000, toRad=x=>x*Math.PI/180;
  const dlat=toRad(lat2-lat1), dlon=toRad(lon2-lon1);
  const a = Math.sin(dlat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dlon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
};
function escapeHTML(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function shortName(s,max=36){let t=String(s).split(',')[0].replace(/\s*\(.+?\)\s*/g,'').trim();if(t.length>max)t=t.slice(0,max-1)+'â€¦';return t;}
const fmtLL = (lat,lon)=>`${(+lat).toFixed(5)}, ${(+lon).toFixed(5)}`;

/* ===== çŠ¶æ…‹ ===== */
let pts=[], map, markerLayer, routeLayers={}, lastDirTs=0;
let lastFastest=null,lastMass=0,lastFlat=18;

const poiCache = new Map();
const cacheKey = (lat,lon,mask)=>`${lat.toFixed(3)},${lon.toFixed(3)},${mask}`;

/* ===== åˆæœŸåŒ– ===== */
window.addEventListener('DOMContentLoaded',()=>{
  map=L.map('map').setView([34.07,134.55],11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â©OpenStreetMap'}).addTo(map);
  map.createPane('routeSlope').style.zIndex=690;
  map.createPane('routeShortest').style.zIndex=700;
  map.createPane('routeFastest').style.zIndex=710;
  map.createPane('markersTop').style.zIndex=800;

  $('searchBtn').onclick   = ()=>{const q=$('placeInput').value.trim();q&&nomSearch(q);};
  $('locBtn').onclick      = addCurrent;
  $('drawBtn').onclick     = drawRoutes;

  $('btnDownloadTime').onclick = ()=>downloadEnergyGraphByTime(lastFastest,lastMass,lastFlat);
  $('btnDownloadDist').onclick = ()=>downloadEnergyGraphByDistance(lastFastest,lastMass,lastFlat);

  $('restModeBtn').onclick = ()=>{ $('restToggle').checked=!$('restToggle').checked; $('restModeBtn').textContent='ä¼‘æ†©è¾¼ã¿: '+($('restToggle').checked?'ON':'OFF'); drawRoutes(); };
  $('restBasis').onchange  = e=>{ const v=e.target.value; $('timeBox').style.display=v==='time'?'inline-flex':'none'; $('energyBox').style.display=v==='energy'?'inline-flex':'none'; };
  document.addEventListener('click',e=>{const b=e.target.closest('.presetKJ');if(b) $('restKJ').value=b.dataset.kj;});
  initSortable();
});

/* ===== Nominatim æ¤œç´¢ ===== */
async function nomSearch(q){
  let url=`https://nominatim.openstreetmap.org/search?format=json&limit=10&q=${encodeURIComponent(q)}`;
  if($('nearbyOnly').checked){
    const b=map.getBounds();
    url+=`&viewbox=${[b.getWest(),b.getNorth(),b.getEast(),b.getSouth()].join(',')}&bounded=1`;
  }
  const arr=await (await fetch(url)).json();
  const ul=$('searchResults'); ul.innerHTML=''; ul.hidden=!arr.length;
  arr.forEach(o=>{
    const li=document.createElement('li'); li.textContent=o.display_name;
    li.onclick=()=>{addPoint({name:o.display_name,lat:+o.lat,lon:+o.lon});ul.hidden=true;$('placeInput').value='';};
    ul.appendChild(li);
  });
}

/* ===== ãƒªã‚¹ãƒˆæ“ä½œ ===== */
function addPoint(p){p.type=pts.length?'':'start';pts.forEach(d=>d.type==='goal'&&(d.type='via'));pts.push(p);if(pts.length>1)pts.at(-1).type='goal';drawList();}
function drawList(){
  const ul=$('pointList');ul.innerHTML='';
  pts.forEach((p,i)=>{
    const li=document.createElement('li');li._idx=i;
    const typeBadge = p.isRest ? 'ğŸŸ¡ä¼‘æ†©' : (p.type==='start'?'ğŸŸ¢å‡ºç™º':(p.type==='goal'?'ğŸ”´ç›®çš„':'ğŸ”µçµŒç”±'));
    const mainLabel = p.isRest
      ? (()=>{const brand=p.brand||p.operator||'';const kind=p.kind?`ï¼ˆ${p.kind}ï¼‰`:'';const btxt=brand?` / ${brand}`:'';return `${typeBadge} <span class="badge">${escapeHTML(shortName(p.name||'ä¼‘æ†©'))}</span>${kind}${btxt}`;})()
      : `${typeBadge}: ${escapeHTML(shortName(p.name||''))}`;
    const sub = p.isRest ? `<div class="sub">ğŸ“ ${fmtLL(p.lat,p.lon)}</div>` : '';
    li.innerHTML=`<div class="row"><span>${mainLabel}</span><button class="del">Ã—</button></div>${sub}`;
    li.querySelector('.del').onclick=e=>{e.stopPropagation();pts.splice(i,1);fixType();drawList();};
    ul.appendChild(li);
  });
}
function fixType(){if(pts[0])pts[0].type='start';if(pts.length>1)pts.at(-1).type='goal';}
function initSortable(){new Sortable($('pointList'),{animation:150,handle:'.row',onEnd:()=>{pts=Array.from($('pointList').children).map(li=>pts[li._idx]);fixType();drawList();}});}

/* ===== ç¾åœ¨åœ° ===== */
function addCurrent(){navigator.geolocation.getCurrentPosition(p=>addPoint({name:'ç¾åœ¨åœ°',lat:p.coords.latitude,lon:p.coords.longitude}),()=>alert('ç¾åœ¨åœ°å–å¾—å¤±æ•—'));}

/* ===== ORS Directions ===== */
async function post(url,body){const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':ORS_KEY},body:JSON.stringify(body)});if(!r.ok) throw new Error(r.status);return r.json();}
async function dir(body,profile){const wait=1100-(Date.now()-lastDirTs);if(wait>0) await sleep(wait);const d=await post(`${ORS_ROOT}/v2/directions/${profile}/geojson`,body);lastDirTs=Date.now();return d;}

/* ===== Overpassï¼ˆã‚«ãƒ†ã‚´ãƒªON/OFFï¼‰ ===== */
function getCategoryMask(){return( $('catConv').checked?1:0 )|( $('catMichi').checked?2:0 )|( $('catSuper').checked?4:0 )|( $('catDrug').checked?8:0 );}
function buildOverpassFilters(mask,r,lat,lon){
  const q=[]; if(mask&1){q.push(`node(around:${r},${lat},${lon})[shop=convenience];`);}
  if(mask&4){q.push(`node(around:${r},${lat},${lon})[shop=supermarket];`);}
  if(mask&8){q.push(`node(around:${r},${lat},${lon})[shop=chemist];`);q.push(`node(around:${r},${lat},${lon})[amenity=pharmacy];`);}
  if(mask&2){q.push(`node(around:${r},${lat},${lon})[name~"é“ã®é§…"];qpush=`}
  return q;
}
async function overpassFetch(query,timeoutMs=7000){
  const ctrl=new AbortController();const timer=setTimeout(()=>ctrl.abort('timeout'),timeoutMs);
  try{const res=await fetch(OVERPASS_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body:'data='+encodeURIComponent(query),signal:ctrl.signal});if(!res.ok) throw new Error('HTTP '+res.status);return await res.json();}finally{clearTimeout(timer);}
}
function friendlyKindFromTags(tags){if(tags.shop==='convenience')return'ã‚³ãƒ³ãƒ“ãƒ‹';if(tags.shop==='supermarket')return'ã‚¹ãƒ¼ãƒ‘ãƒ¼';if(tags.shop==='chemist')return'ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢';if(tags.amenity==='pharmacy')return'ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢';if((tags.highway==='rest_area'||tags.tourism==='information')&&/é“ã®é§…/.test(tags.name||''))return'é“ã®é§…';if(/é“ã®é§…/.test(tags?.name||''))return'é“ã®é§…';return'';}
function bestName(tags){const friendly=friendlyKindFromTags(tags||{});const nm=(tags&&(tags['name:ja']||tags.name||tags.brand||tags.operator))||'';return nm||(friendly?`ä¼‘æ†©ï¼ˆ${friendly}ï¼‰`:'ä¼‘æ†©');}
async function nearPoi(lat,lon){
  const mask=getCategoryMask();const ck=cacheKey(lat,lon,mask);if(poiCache.has(ck))return poiCache.get(ck);
  if(mask===0){const fb={geometry:{coordinates:[lon,lat]},properties:{name:'ä¼‘æ†©',kind:'',brand:'',operator:''}};poiCache.set(ck,fb);return fb;}
  for(const r of RADII){
    const filters=buildOverpassFilters(mask,r,lat,lon); if(!filters.length) continue;
    const query=`[out:json][timeout:10];(${filters.join('\n')});out body 30;`;
    try{
      const data=await overpassFetch(query,7000);const els=data.elements||[];
      if(els.length){
        let candidates=els;const michi=els.filter(n=>/é“ã®é§…/.test((n.tags&&n.tags.name)||''));if(michi.length)candidates=michi;
        let best=null,bestD=Infinity;for(const n of candidates){const d=havDist(lat,lon,n.lat,n.lon);if(d<bestD){best=n;bestD=d;}}
        const tags=best.tags||{};const kind=friendlyKindFromTags(tags);const nm=bestName(tags);
        const poi={geometry:{coordinates:[best.lon,best.lat]},properties:{name:nm,kind,brand:tags.brand||'',operator:tags.operator||''}};
        poiCache.set(ck,poi);return poi;
      }
    }catch(e){}
  }
  const fb={geometry:{coordinates:[lon,lat]},properties:{name:'ä¼‘æ†©',kind:'',brand:'',operator:''}};poiCache.set(ck,fb);return fb;
}
const isClose=(lat,lon)=>{const g=pts.at(-1);return g?L.latLng(lat,lon).distanceTo([g.lat,g.lon])<=CLOSE_TO_GOAL_M:false;};

/* ===== ä¼‘æ†©ãƒ­ã‚¸ãƒƒã‚¯ ===== */
const energyStepKJ=(d,dz,m,flat)=>flat*(d/1000)+Math.max(dz,0)*m*9.80665/1000;
async function makeRest(feat,basis,mass,flat,thr){
  const crd=feat.geometry.coordinates,segs=feat.properties.segments,hasEle=crd[0].length>=3;
  let acc=0,res=[];
  for(const seg of segs){for(const st of seg.steps){
    const [i0,i1]=st.way_points,d=st.distance||0,t=st.duration||0,dz=hasEle?(crd[i1][2]-crd[i0][2]):0;
    acc+=basis==='time'?t:energyStepKJ(d,dz,mass,flat);
    if(acc>=thr){
      const [lon,lat]=crd[i1];
      if(isClose(lat,lon)){acc=0;continue;}
      const poi=await nearPoi(lat,lon);
      if(isClose(poi.geometry.coordinates[1],poi.geometry.coordinates[0])){acc=0;continue;}
      res.push({
        name:poi.properties.name||'ä¼‘æ†©',
        lat:poi.geometry.coordinates[1],lon:poi.geometry.coordinates[0],
        type:'via',isRest:true,
        brand:poi.properties.brand||'',operator:poi.properties.operator||'',kind:poi.properties.kind||''
      });
      acc=0;
    }
  }}return res;
}

/* ===== ä¼‘æ†©ãƒãƒ¼ã‚«ãƒ¼ä½œæˆï¼ˆã‚°ãƒ©ãƒ•ç”¨ï¼‰ ===== */
function buildRestMarkersBySteps(feature, restPoints, tolM=60){
  // restPoints ã¯ pts.filter(p=>p.isRest)
  const coords=feature.geometry.coordinates;
  const idxMarkers=[]; // {index, label}
  const remaining = restPoints.map(r=>({...r, hit:false}));
  let idx=0;
  for(const seg of feature.properties.segments){
    for(const st of seg.steps){
      const [i0,i1]=st.way_points;
      const [lon,lat]=coords[i1];
      for(const rp of remaining){
        if(rp.hit) continue;
        const d = havDist(lat,lon,rp.lat,rp.lon);
        if(d <= tolM){
          idxMarkers.push({index:idx, label: rp.name});
          rp.hit=true;
        }
      }
      idx++;
    }
  }
  // ã¾ã‚Œã«ç«¯æ•°åº§æ¨™ã§æ‹¾ãˆãªã„æ™‚ã¯æœ€å¯„ã‚¹ãƒ†ãƒƒãƒ—ã«å¸ç€ï¼ˆç°¡æ˜“ï¼‰
  remaining.filter(r=>!r.hit).forEach(r=>{
    let bestI=0,bestD=1e12, i=-1;
    for(const seg of feature.properties.segments){
      for(const st of seg.steps){
        const [i0,i1]=st.way_points;
        i++;
        const [lon,lat]=coords[i1];
        const d=havDist(lat,lon,r.lat,r.lon);
        if(d<bestD){bestD=d;bestI=i;}
      }
    }
    idxMarkers.push({index:bestI, label:r.name});
  });
  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ˜‡é †ãƒ»é‡è¤‡é™¤å»
  const seen=new Set(); return idxMarkers
    .sort((a,b)=>a.index-b.index)
    .filter(m=>{const k=m.index; if(seen.has(k)) return false; seen.add(k); return true;});
}

/* ===== ã‚°ãƒ©ãƒ•ï¼ˆã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æç”»ï¼‰ ===== */
function tempShowChartsContainer(show){
  const charts = $('charts');
  if(show){charts.style.display='block';charts.style.position='absolute';charts.style.left='-99999px';charts.style.top='0';charts.style.visibility='hidden';}
  else{charts.removeAttribute('style');charts.style.display='none';}
}
function prepareCanvasSize(canvas, w=1600, h=900){canvas.width=w;canvas.height=h;}

/* ä¼‘æ†©ç¸¦ç·šãƒ—ãƒ©ã‚°ã‚¤ãƒ³ */
const restMarkersPlugin = {
  id:'restMarkers',
  afterDraw(chart, args, opts){
    const markers = opts?.markers||[]; if(!markers.length) return;
    const {ctx, scales:{x,y}} = chart;
    ctx.save();
    ctx.lineWidth = 1;
    ctx.strokeStyle = '#888';
    ctx.fillStyle = '#111';
    ctx.font = '12px system-ui, sans-serif';
    markers.forEach((m,i)=>{
      const xPos = x.getPixelForValue(m.index);
      ctx.beginPath();
      ctx.moveTo(xPos, y.top);
      ctx.lineTo(xPos, y.bottom);
      ctx.stroke();
      // ãƒ©ãƒ™ãƒ«ã‚’ä¸Šã«ï¼ˆã¯ã¿å‡ºã—é˜²æ­¢ã®ãŸã‚å°‘ã—å†…å´ï¼‰
      const label = 'ä¼‘æ†©: '+ (m.label? (m.label.length>16? m.label.slice(0,15)+'â€¦' : m.label) : '');
      const textW = ctx.measureText(label).width;
      let tx = Math.min(Math.max(xPos - textW/2, x.left+4), x.right - textW - 4);
      let ty = y.top + 14;
      ctx.fillStyle = 'rgba(255,255,255,0.9)';
      ctx.fillRect(tx-2, ty-12, textW+4, 16);
      ctx.fillStyle = '#111';
      ctx.fillText(label, tx, ty);
    });
    ctx.restore();
  }
};

/* ===== æ™‚é–“Ã—ç´¯ç©kJ ===== */
function buildEnergyTimeSeriesBySteps(feature, mass, flat, restPts){
  const coords = feature.geometry.coordinates;
  const hasEle = coords[0].length >= 3;
  let cumT = 0, cumE = 0, idx=0;
  const tMin=[], eKJ=[];
  for(const seg of feature.properties.segments){
    for(const st of seg.steps){
      const [i0,i1] = st.way_points;
      const d  = st.distance || 0;
      const dt = st.duration || 0;
      const dz = hasEle ? ((coords[i1][2]||0)-(coords[i0][2]||0)) : 0;
      const dE = energyStepKJ(d,dz,mass,flat);
      cumT += dt; cumE += dE;
      tMin.push((cumT/60).toFixed(2));
      eKJ .push(+cumE.toFixed(1));
      idx++;
    }
  }
  const markers = buildRestMarkersBySteps(feature, restPts);
  return { labels:tMin, values:eKJ, markers, xlabel:'æ™‚é–“ (åˆ†)', ylabel:'ç´¯ç©ã‚¨ãƒãƒ«ã‚®ãƒ¼ (kJ)', filename:'energy_over_time.png' };
}
function downloadEnergyGraphByTime(fastestFeature, mass, flat){
  if(!fastestFeature){ alert('å…ˆã«ãƒ«ãƒ¼ãƒˆã‚’æç”»ã—ã¦ãã ã•ã„'); return; }
  const restPts = pts.filter(p=>p.isRest);
  const series = buildEnergyTimeSeriesBySteps(fastestFeature, mass, flat, restPts);
  downloadLineChart(series);
}

/* ===== è·é›¢Ã—ç´¯ç©kJ ===== */
function buildEnergyDistanceSeriesBySteps(feature, mass, flat, restPts){
  const coords = feature.geometry.coordinates;
  const hasEle = coords[0].length >= 3;
  let cumD = 0, cumE = 0, idx=0;
  const km=[], eKJ=[];
  for(const seg of feature.properties.segments){
    for(const st of seg.steps){
      const [i0,i1] = st.way_points;
      const d  = st.distance || 0; // m
      const dz = hasEle ? ((coords[i1][2]||0)-(coords[i0][2]||0)) : 0;
      const dE = energyStepKJ(d,dz,mass,flat);
      cumD += d;      // m
      cumE += dE;     // kJ
      km .push((cumD/1000).toFixed(2));
      eKJ.push(+cumE.toFixed(1));
      idx++;
    }
  }
  const markers = buildRestMarkersBySteps(feature, restPts);
  return { labels:km, values:eKJ, markers, xlabel:'è·é›¢ (km)', ylabel:'ç´¯ç©ã‚¨ãƒãƒ«ã‚®ãƒ¼ (kJ)', filename:'energy_over_distance.png' };
}
function downloadEnergyGraphByDistance(fastestFeature, mass, flat){
  if(!fastestFeature){ alert('å…ˆã«ãƒ«ãƒ¼ãƒˆã‚’æç”»ã—ã¦ãã ã•ã„'); return; }
  const restPts = pts.filter(p=>p.isRest);
  const series = buildEnergyDistanceSeriesBySteps(fastestFeature, mass, flat, restPts);
  downloadLineChart(series);
}

/* ===== å…±æœ‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–¢æ•°ï¼ˆä¼‘æ†©ãƒãƒ¼ã‚«ãƒ¼å¯¾å¿œï¼‰ ===== */
function downloadLineChart({labels, values, markers, xlabel, ylabel, filename}){
  tempShowChartsContainer(true);
  const ec = $('energyChart');
  prepareCanvasSize(ec, 1600, 900);

  const ch = new Chart(ec, {
    type: 'line',
    data: { labels, datasets: [{ label: ylabel, data: values, borderWidth:2, pointRadius:0 }] },
    options: {
      animation:false,
      plugins:{ legend:{ display:false }, restMarkers:{ markers: markers||[] } },
      scales:{
        x:{ title:{ display:true, text: xlabel } },
        y:{ title:{ display:true, text: ylabel } }
      }
    },
    plugins: [restMarkersPlugin]
  });

  setTimeout(()=>{
    ec.toBlob(b=>{
      if(!b){ alert('PNG ç”Ÿæˆã«å¤±æ•—'); return; }
      const u=URL.createObjectURL(b);
      const a=document.createElement('a'); a.href=u; a.download=filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(u),1000);
      ch.destroy();
      tempShowChartsContainer(false);
    },'image/png');
  },120);
}

/* ===== ãƒ«ãƒ¼ãƒˆæç”» ===== */
async function drawRoutes(){
  $('btnDownloadTime').disabled=true;
  $('btnDownloadDist').disabled=true;
  lastFastest=null;

  if(pts.length<2){alert('2åœ°ç‚¹ä»¥ä¸Šç™»éŒ²ã—ã¦ãã ã•ã„');return;}

  Object.values(routeLayers).forEach(l=>l&&map.removeLayer(l)); routeLayers={};
  if(markerLayer) map.removeLayer(markerLayer);

  // ä¼‘æ†©ã‚’ä¸€æ—¦é™¤å»ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
  pts = pts.filter(p => !p.isRest);
  fixType();
  drawList();

  const profile=$('profileSelect').value;
  const mass=Number($('riderWeight').value)+Number($('bikeWeight').value);
  const flat =Number($('flatKJperKm').value);
  const basis=$('restBasis').value;
  const thr  =basis==='time'?Number($('restMinutes').value)*60:Number($('restKJ').value);

  // ä¼‘æ†©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€é€Ÿ1å›ã§è¨ˆç®—ï¼‰
  try{
    if($('restToggle').checked){
      const preview=await dir({coordinates:pts.map(p=>[p.lon,p.lat]),elevation:true,extra_info:['steepness'],preference:'fastest'},profile);
      const rests=await makeRest(preview.features[0],basis,mass,flat,thr);
      if(rests.length){
        const insertPos=Math.max(pts.length-1,1);
        pts.splice(insertPos,0,...rests);
        fixType(); drawList();
      }
    }
  }catch(e){console.warn('ä¼‘æ†©åœ°ç‚¹å–å¾—å¤±æ•—',e);}

  // ãƒãƒ¼ã‚«ãƒ¼ï¼ˆæœ€å‰é¢ï¼‰
  markerLayer=L.layerGroup([], { pane:'markersTop' }).addTo(map);
  pts.forEach(p=>{
    const ic = p.isRest ? ICONS.rest : (p.type==='start'?ICONS.start:p.type==='goal'?ICONS.goal:ICONS.via);
    const brandText = p.isRest ? (p.brand || p.operator || p.kind || '') : '';
    const tipName = p.name + (brandText? ` / ${brandText}` : '');
    const mk=L.marker([p.lat,p.lon],{icon:ic,pane:'markersTop',zIndexOffset:1000})
      .bindTooltip(`${tipName}${p.isRest?'ï¼ˆä¼‘æ†©ï¼‰':''}\n${fmtLL(p.lat,p.lon)}`,{direction:'top',offset:[0,-20]});
    markerLayer.addLayer(mk);
  });

  // ãƒ«ãƒ¼ãƒˆæœ¬ä½“
  const coords=pts.map(p=>[p.lon,p.lat]), base={coordinates:coords,elevation:true,extra_info:['steepness']};
  try{
    const shortest = await dir({...base,preference:'shortest'},profile);
    const fastest  = await dir({...base,preference:'fastest'},profile);
    let slope=shortest.features[0];
    if(coords.length===2){
      const alt=await dir({...base,preference:'shortest',alternative_routes:{target_count:3,share_factor:0.6,weight_factor:1.4}},profile);
      slope=alt.features.reduce((a,b)=>steepSum(a)<steepSum(b)?a:b);
    }

    routeLayers.short=L.geoJSON(shortest.features[0],{pane:'routeShortest',style:{color:'#ff0000',weight:6}}).addTo(map);
    routeLayers.fast =L.geoJSON(fastest.features[0] ,{pane:'routeFastest' ,style:{color:'#0066ff',weight:6,dashArray:'4 4'}}).addTo(map);
    routeLayers.slope=L.geoJSON(slope               ,{pane:'routeSlope'  ,style:{color:'#ff9900',weight:6,opacity:0.9}}).addTo(map);
    updateLayerVisibility();

    const bounds=new L.LatLngBounds();
    markerLayer.eachLayer(l=>bounds.extend(l.getLatLng()));
    Object.values(routeLayers).forEach(l=>bounds.extend(l.getBounds()));
    if(bounds.isValid()) map.fitBounds(bounds.pad(0.1));

    const s1=shortest.features[0].properties.summary,s2=fastest.features[0].properties.summary,s3=slope.properties.summary;
    $('routeInfo').innerHTML=
      `<b>æœ€çŸ­</b> ${formatDist(s1.distance)} / ${formatDur(s1.duration)}<br>`+
      `<b>æœ€é€Ÿ</b> ${formatDist(s2.distance)} / ${formatDur(s2.duration)}<br>`+
      `<b>å‹¾é…</b> ${formatDist(s3.distance)} / ${formatDur(s3.duration)}`;
    $('distanceScore').textContent=`è·é›¢å·®: ${(s2.distance-s1.distance).toFixed(0)} m`;

    lastFastest=fastest.features[0]; lastMass=mass; lastFlat=flat;
    $('btnDownloadTime').disabled=false;
    $('btnDownloadDist').disabled=false;
  }catch(e){console.error(e);alert('ãƒ«ãƒ¼ãƒˆå–å¾—å¤±æ•—: '+e.message);}
}
function updateLayerVisibility(){const m={short:'chkShortest',fast:'chkFastest',slope:'chkSlope'};for(const k in routeLayers){routeLayers[k]&&($(m[k]).checked?routeLayers[k].addTo(map):map.removeLayer(routeLayers[k]));}}
</script>
</body>
</html>
