<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>地名検索と自前ルート探索</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet/dist/leaflet.css"
/>
<style>
  body {
    margin: 0;
    display: flex;
    font-family: sans-serif;
  }
  #map {
    flex: 1;
    height: 100vh;
  }
  #control-panel {
    width: 320px;
    padding: 12px;
    background: #f8f8f8;
    box-shadow: 2px 0 6px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  label {
    font-weight: bold;
  }
  input[type=text] {
    width: 100%;
    padding: 6px;
    font-size: 14px;
    box-sizing: border-box;
  }
  button {
    padding: 8px;
    font-size: 14px;
    cursor: pointer;
  }
  .autocomplete-items {
    border: 1px solid #ddd;
    max-height: 140px;
    overflow-y: auto;
    background: white;
    position: relative;
    z-index: 1000;
  }
  .autocomplete-item {
    padding: 6px;
    cursor: pointer;
  }
  .autocomplete-item:hover {
    background-color: #e0e0e0;
  }
  #status {
    font-size: 12px;
    color: #555;
    min-height: 20px;
  }
</style>
</head>
<body>

<div id="control-panel">
  <h2>地名検索＋自前ルート探索</h2>

  <label for="start-input">開始地名検索</label>
  <input id="start-input" type="text" placeholder="開始地名を入力" autocomplete="off" />
  <div id="start-suggestions" class="autocomplete-items"></div>

  <label for="goal-input">終了地名検索</label>
  <input id="goal-input" type="text" placeholder="終了地名を入力" autocomplete="off" />
  <div id="goal-suggestions" class="autocomplete-items"></div>

  <button id="btn-route">ルート検索</button>
  <button id="btn-current">現在地を取得</button>
  <div id="status"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // 地図初期化
  const map = L.map('map').setView([35.681, 139.767], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // --- 自前の道路ネットワーク（簡易例） ---
  // ここでは適当に都内っぽい座標をつなぐグラフとして作成（ID: {lat, lon, edges}）
  // edges: {to: ノードID, cost: 距離（m）}
  const graph = {
    '1': { lat: 35.681, lon: 139.766, edges: [{to:'2', cost:100}, {to:'3', cost:150}] },
    '2': { lat: 35.682, lon: 139.767, edges: [{to:'1', cost:100}, {to:'4', cost:120}] },
    '3': { lat: 35.680, lon: 139.768, edges: [{to:'1', cost:150}, {to:'4', cost:130}] },
    '4': { lat: 35.683, lon: 139.769, edges: [{to:'2', cost:120}, {to:'3', cost:130}] }
  };

  // ノードマーカー表示（任意）
  const nodeMarkers = {};
  for (const id in graph) {
    const n = graph[id];
    nodeMarkers[id] = L.circleMarker([n.lat, n.lon], {
      radius: 6, color: 'gray', fillColor: 'white', fillOpacity: 1, weight: 1
    }).addTo(map);
  }

  // 地名検索 API (Nominatim) URL 作成
  function nominatimSearch(query) {
    return `https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(query)}`;
  }

  // 入力欄と候補表示エリア
  const startInput = document.getElementById('start-input');
  const startSug = document.getElementById('start-suggestions');
  const goalInput = document.getElementById('goal-input');
  const goalSug = document.getElementById('goal-suggestions');
  const status = document.getElementById('status');

  // 選択された地点の情報 {lat, lon, display_name}
  let startPoint = null;
  let goalPoint = null;

  // 候補表示・選択処理
  function setupSearch(inputElem, sugElem, setPoint) {
    inputElem.addEventListener('input', () => {
      const val = inputElem.value.trim();
      sugElem.innerHTML = '';
      if (val.length < 2) return; // 2文字以上から検索

      fetch(nominatimSearch(val))
        .then(resp => resp.json())
        .then(results => {
          sugElem.innerHTML = '';
          results.forEach(r => {
            const div = document.createElement('div');
            div.classList.add('autocomplete-item');
            div.textContent = r.display_name;
            div.addEventListener('click', () => {
              inputElem.value = r.display_name;
              sugElem.innerHTML = '';
              setPoint({
                lat: parseFloat(r.lat),
                lon: parseFloat(r.lon),
                display_name: r.display_name
              });
              status.textContent = `${inputElem.id === 'start-input' ? '開始地点' : '終了地点'}が選択されました`;
              // マーカー表示
              updateMarker(inputElem.id, r.lat, r.lon);
            });
            sugElem.appendChild(div);
          });
        }).catch(() => {
          status.textContent = '検索エラー';
        });
    });

    // フォーカスアウトで候補非表示
    inputElem.addEventListener('blur', () => {
      setTimeout(() => { sugElem.innerHTML = ''; }, 150);
    });
  }

  // マーカー管理
  let startMarker = null;
  let goalMarker = null;
  let routeLayer = null;

  function updateMarker(type, lat, lon) {
    if (type === 'start-input') {
      if (startMarker) map.removeLayer(startMarker);
      startMarker = L.marker([lat, lon], {title: '開始地点'}).addTo(map);
    } else {
      if (goalMarker) map.removeLayer(goalMarker);
      goalMarker = L.marker([lat, lon], {title: '終了地点'}).addTo(map);
    }
  }

  // --- A* アルゴリズム ---
// ヒュ
