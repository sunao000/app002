<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>自転車ルート比較＋自動休憩（時間／kJ／レート）v5.3</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
  body{margin:0;font-family:system-ui,sans-serif}
  #map{height:500px;width:100%}
  #controls{display:flex;flex-wrap:wrap;gap:8px;padding:8px;background:#f7f7f7}
  #pointList{list-style:none;margin:0;padding:0}
  #pointList li{display:flex;align-items:center;justify-content:space-between;padding:4px 8px;border:1px solid #ccc;background:#fafafa;margin-bottom:4px;cursor:move}
  button.del{background:#d9534f;color:#fff;border:none;border-radius:4px;padding:0 6px;font-size:12px}
  #searchResults{position:absolute;z-index:1000;width:260px;max-height:200px;overflow-y:auto;margin:4px 0 0;padding:0;list-style:none;border:1px solid #ccc;background:#fff}
  #searchResults li{padding:4px 8px;cursor:pointer}
  #searchResults li:hover{background:#e0e0e0}
  #summary{padding:8px;background:#fafafa;border-top:1px solid #ddd;font-size:0.9rem}
  .legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:4px;font-size:0.8rem}
  .legend-item{display:flex;align-items:center;gap:4px}
  .legend-color{width:14px;height:14px;border-radius:3px}
  .section{padding:8px;background:#fff;border-top:1px solid #eee}
  .group{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .muted{color:#666;font-size:0.85em}
  .presetKJ{border:1px solid #ccc;border-radius:14px;padding:2px 8px;font-size:.85em;background:#fff;cursor:pointer}
  .presetKJ:hover{background:#f0f0f0}
  .tips{font-size:.9em;line-height:1.5}
  details{border:1px solid #ddd;border-radius:6px;padding:6px;background:#fff}
</style>
</head>
<body>

<div id="controls">
  <input id="placeInput" placeholder="地名・住所" style="width:260px" />
  <button id="searchBtn">検索</button>
  <label><input type="checkbox" id="nearbyOnly" /> 近くの場所のみ</label>
  <button id="locBtn">現在地追加</button>

  <input id="restToggle" type="checkbox" checked hidden />
  <button id="restModeBtn">休憩込み: ON</button>

  <label>基準
    <select id="restBasis">
      <option value="time" selected>時間</option>
      <option value="energy">kJ累積</option>
      <option value="energy-rate">kJ/km 変化率</option>
    </select>
  </label>

  <span id="timeBox" class="group">
    <label>間隔 <input id="restMinutes" type="number" value="60" min="15" step="5" style="width:70px" /> 分</label>
  </span>
  <span id="energyBox" class="group" style="display:none">
    <label>しきい値 <input id="restKJ" type="number" value="500" min="100" step="50" style="width:90px" /> kJ</label>
    <button type="button" class="presetKJ" data-kj="400">400</button>
    <button type="button" class="presetKJ" data-kj="500">500</button>
    <button type="button" class="presetKJ" data-kj="650">650</button>
  </span>
  <span id="energyRateBox" class="group" style="display:none">
    <label>レート <input id="restRateKJ" type="number" value="28" min="10" step="1" style="width:70px" /> kJ/km</label>
    <label>窓幅 <input id="rateWindow" type="number" value="500" min="100" step="100" style="width:70px" /> m</label>
  </span>

  <select id="profileSelect">
    <option value="cycling-road" selected>ロードバイク</option>
    <option value="cycling-regular">自転車（一般）</option>
  </select>
  <button id="drawBtn">ルート表示</button>

  <label><input type="checkbox" id="chkShortest" checked /> 最短</label>
  <label><input type="checkbox" id="chkFastest" checked /> 最速</label>
  <label><input type="checkbox" id="chkSlope" checked /> 勾配</label>
</div>

<div class="section">
  <div class="group">
    <label>体重 <input id="riderWeight" type="number" value="65" min="30" max="150" step="0.5" style="width:80px" /> kg</label>
    <label>バイク重量 <input id="bikeWeight" type="number" value="10" min="5" max="30" step="0.1" style="width:80px" /> kg</label>
  </div>
  <details>
    <summary>平坦係数 (kJ/km)</summary>
    <label><input id="flatKJperKm" type="number" value="18" min="10" max="30" step="0.5" style="width:90px" /></label>
  </details>
</div>

<ul id="searchResults" hidden></ul>
<ul id="pointList"></ul>
<div id="map"></div>

<div id="summary">
  <div id="routeInfo"></div>
  <div id="metricInfo" class="muted"></div>
  <div id="distanceScore" class="muted"></div>
  <div id="uniformity"></div>
  <div class="legend">
    <div class="legend-item"><span class="legend-color" style="background:#ff0000"></span> 最短</div>
    <div class="legend-item"><span class="legend-color" style="background:#0066ff"></span> 最速</div>
    <div class="legend-item"><span class="legend-color" style="background:#ff9900"></span> 勾配</div>
  </div>
</div>

<script>
(function(){
  /* =================== 設定 =================== */
  const ORS_KEY  = '5b3ce3597851110001cf62481af47799d9c344bf86dd4b340f9f9ff9';                 // ← ご自身の API キー   (必須)
  const ORS_ROOT = 'https://api.openrouteservice.org';
  /**
   * ★ CORS プロキシはできるだけ使わない ★
   *   - ORS は公式に Access-Control-Allow-Origin を返すので通常は不要
   *   - ブラウザ拡張やローカルサーバ―で OPTIONS プリフライトを許可すれば OK
   * どうしても必要な場合のみ ↓ に書く（Header が落ちるので URL?api_key=xx 形式）
   */
  const PROXY    = '';// 例: 'https://cors.isomorphic-git.org/'

  /* API 呼び出し制御 */
  const MIN_INTERVAL_MS = 1250;        // Directions / POI 共通ウェイト
  const POI_MAX_FAIL    = 5;           // 連続失敗で POI検索を打ち切る

  /* ================================================= */

  const POI_CATS = [451,443,624,518];
  const CAT_NAME = {451:'コンビニ',443:'ドラッグストア',624:'道の駅',518:'スーパー'};
  const RADII    = [1000,2000,3500];
  const CLOSE_TO_GOAL_M = 500;

  const $ = id=>document.getElementById(id);
  const formatDist = d=>(d/1000).toFixed(2)+' km';
  const formatDur  = s=>{const m=Math.round(s/60);return m<60?`${m} 分`:`${Math.floor(m/60)} 時間 ${m%60} 分`;};
  const sleep = ms=>new Promise(r=>setTimeout(r,ms));
  const rd = (x,n=1)=>Number.isFinite(x)?Number(x.toFixed(n)):x;

  let pts=[]; let map; let markerLayer; let routeLayers={};
  let poiCache=new Map(); let lastDirTs=0; let lastAccum={energyKJ:0,timeSec:0};
  let poiFailCount=0;

  /* ---------- UI 初期化 ---------- */
  window.addEventListener('DOMContentLoaded',()=>{
    map=L.map('map').setView([34.07,134.55],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'©OpenStreetMap'}).addTo(map);
    map.createPane('routeSlope'   ).style.zIndex=690;
    map.createPane('routeShortest').style.zIndex=700;
    map.createPane('routeFastest' ).style.zIndex=710;

    $('searchBtn').onclick = ()=>{const q=$('placeInput').value.trim();q&&nomSearch(q)};
    $('locBtn').onclick    = addCurrent;
    $('drawBtn').onclick   = drawRoutes;
    ['chkShortest','chkFastest','chkSlope'].forEach(id=>$(id).onchange=updateLayerVisibility);
    $('restModeBtn').onclick = ()=>{ $('restToggle').checked=!$('restToggle').checked; $('restModeBtn').textContent='休憩込み: '+($('restToggle').checked?'ON':'OFF'); drawRoutes(); };
    $('restBasis').onchange = ()=>{ const m=$('restBasis').value; $('timeBox').style.display=(m==='time')?'inline-flex':'none'; $('energyBox').style.display=(m==='energy')?'inline-flex':'none'; $('energyRateBox').style.display=(m==='energy-rate')?'inline-flex':'none'; };
    initSortable();
  });

  /* ---------- Nominatim 検索 ---------- */
  async function nomSearch(q){
    let url=`https://nominatim.openstreetmap.org/search?format=json&limit=10&q=${encodeURIComponent(q)}`;
    if($('nearbyOnly').checked){ const b=map.getBounds(), box=[b.getWest(),b.getNorth(),b.getEast(),b.getSouth()].join(','); url+=`&viewbox=${box}&bounded=1`; }
    const arr=await (await fetch(url)).json(), ul=$('searchResults'); ul.innerHTML=''; ul.hidden=!arr.length;
    arr.forEach(o=>{ const li=document.createElement('li'); li.textContent=o.display_name; li.onclick=()=>{addPoint({name:o.display_name,lat:+o.lat,lon:+o.lon});ul.hidden=true;$('placeInput').value='';}; ul.appendChild(li);} );
  }

  /* ---------- 地点リスト ---------- */
  function addPoint(p){ p.type=pts.length?'':'start'; pts.forEach(d=>d.type==='goal'&&(d.type='via')); pts.push(p); if(pts.length>1)pts.at(-1).type='goal'; drawList(); }
  function drawList(){ const ul=$('pointList'); ul.innerHTML=''; pts.forEach((p,i)=>{ const li=document.createElement('li'); li._idx=i; li.innerHTML=`<span>${p.name}</span>`; const del=document.createElement('button'); del.textContent='×'; del.className='del'; del.onclick=e=>{e.stopPropagation();pts.splice(i,1);fixType();drawList();}; li.appendChild(del); ul.appendChild(li);} ); }
  const fixType=()=>{if(pts[0])pts[0].type='start'; if(pts.length>1)pts.at(-1).type='goal';};
  function initSortable(){ new Sortable($('pointList'),{animation:150,handle:'span',onEnd:()=>{pts=Array.from($('pointList').children).map(li=>pts[li._idx]);fixType();drawList();}}); }

  /* ---------- 現在地 ---------- */
  function addCurrent(){ navigator.geolocation.getCurrentPosition(p=>addPoint({name:'現在地',lat:p.coords.latitude,lon:p.coords.longitude}), ()=>alert('現在地取得失敗')); }

  /* ---------- 共通 HTTP ---------- */
  async function throttledPost(url, body){ const wait=MIN_INTERVAL_MS-(Date.now()-lastDirTs); if(wait>0) await sleep(wait); const target=PROXY?`${PROXY}${url}?api_key=${ORS_KEY}`:url; const r=await fetch(target,{method:'POST',headers:PROXY?{"Content-Type":"application/json"}:{"Content-Type":"application/json","Authorization":ORS_KEY},body:JSON.stringify(body)}); lastDirTs=Date.now(); if(!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`); return r.json(); }

  const fetchRoute=(body,profile)=>throttledPost(`${ORS_ROOT}/v2/directions/${profile}/geojson`,body);

  /* ---------- POI ---------- */
  async function postPOI(body){ if(poiFailCount>=POI_MAX_FAIL) throw new Error('POI disabled after consecutive failures'); try{ return await throttledPost(`${ORS_ROOT}/pois`,body);} catch(e){ poiFailCount++; if(poiFailCount>=POI_MAX_FAIL) console.warn('POI 検索を停止しました'); throw e; } }

  const pName=p=>{const t=p.properties?.osm_tags||{}; return t['name:ja']||t.name||t.brand||t.operator||CAT_NAME[arr(p.properties?.category_ids).find(id=>CAT_NAME[id])]||'休憩地点';};
  async function nearPoi(lat,lon){ if(poiFailCount>=POI_MAX_FAIL) return { geometry:{coordinates:[lon,lat]}, properties:{}, fallback:true };
    const tryFetch=async(r,f)=>{ try{ return await postPOI({request:'pois',geometry:{geojson:{type:'Point',coordinates:[lon,lat]},buffer:r},limit:20,sortby:'distance',filters:f}); }catch(_){return null;} };
    for(const radius of RADII){ const d=await tryFetch(radius,{category_ids:POI_CATS.map(Number)}); if(d?.features?.length) return d.features[0]; for(const gid of [420,560,620,200]){ const d2=await tryFetch(radius,{category_group_ids:[gid]}); if(d2?.features?.length) return d2.features[0]; }
      const d3=await tryFetch(radius,null); if(d3?.features?.length) return d3.features[0]; }
    return { geometry:{coordinates:[lon,lat]}, properties:{}, fallback:true };
  }

  /* ---------- エネルギー計算 ---------- */
  const energyStepKJ=(d,dz,mass,flat)=>flat*(d/1000)+Math.max(dz,0)*mass*9.80665/1000;

  /* ---------- 休憩生成 ---------- */
  async function makeRestByTime(feature,intervalS){ const crd=feature.geometry.coordinates; const segs=feature.properties.segments; let acc=0,res=[]; for(const seg of segs){ for(const st of seg.steps){ acc+=st.duration; if(acc>=intervalS){ const idx=st.way_points[1], [lon,lat]=crd[idx]; if(L.latLng(lat,lon).distanceTo([pts.at(-1).lat,pts.at(-1).lon])<=CLOSE_TO_GOAL_M){ acc=0; continue;} const poi=await nearPoi(lat,lon); res.push({name:pName(poi),lat:poi.geometry.coordinates[1],lon:poi.geometry.coordinates[0],isRest:true}); acc=0; } } } lastAccum.timeSec=acc; return res; }

  async function makeRestByEnergy(feature,mass,flat,thrKJ){ const crd=feature.geometry.coordinates; const segs=feature.properties.segments; let acc=0,res=[]; const hasEle=crd[0].length>=3; for(const seg of segs){ for(const st of seg.steps){ const [i0,i1]=st.way_points; const d=st.distance||0; const dz=(hasEle?(crd[i1][2]||0)-(crd[i0][2]||0):0); acc+=energyStepKJ(d,dz,mass,flat); if(acc>=thrKJ){ const [lon,lat]=crd[i1]; if(L.latLng(lat,lon).distanceTo([pts.at(-1).lat,pts.at(-1).lon])<=CLOSE_TO_GOAL_M){ acc=0; continue;} const poi=await nearPoi(lat,lon); res.push({name:pName(poi),lat:poi.geometry.coordinates[1],lon:poi.geometry.coordinates[0],isRest:true}); acc=0; } } } lastAccum.energyKJ=acc; return res; }

  async function makeRestByEnergyRate(feature,mass,flat,thrRate,windowM){ const crd=feature.geometry.coordinates; const segs=feature.properties.segments; const hasEle=crd[0].length>=3; let res=[],queue=[],distWin=0,energyWin=0; const flush=()=>{queue=[];distWin=0;energyWin=0;}; for(const seg of segs){ for(const st of seg.steps){ const [i0,i1]=st.way_points; const d=st.distance||0; const dz=(hasEle?(crd[i1][2]||0)-(crd[i0][2]||0):0); const dE=energyStepKJ(d,dz,mass,flat); queue.push({d,dE}); distWin+=d; energyWin+=dE; while(distWin>windowM&&queue.length){ const p=queue.shift(); distWin-=p.d; energyWin-=p.dE; }
        const rate=(energyWin/1000)/(distWin/1000);
        if(rate>thrRate){ const [lon,lat]=crd[i1]; if(L.latLng(lat,lon).distanceTo([pts.at(-1).lat,pts.at(-1).lon])<=CLOSE_TO_GOAL_M){ flush(); continue;} const poi=await nearPoi(lat,lon); res.push({name:pName(poi),lat:poi.geometry.coordinates[1],lon:poi.geometry.coordinates[0],isRest:true}); flush(); }
      } }
    return res; }

  /* ---------- ルート描画 ---------- */
  async function drawRoutes(){ if(pts.length<2){alert('2地点以上登録してください');return;}
    poiFailCount=0; Object.values(routeLayers).forEach(l=>l&&map.removeLayer(l)); routeLayers={}; if(markerLayer) map.removeLayer(markerLayer); markerLayer=L.layerGroup().addTo(map);

    const profile=$('profileSelect').value; const coords=pts.map(p=>[p.lon,p.lat]); const base={coordinates:coords,elevation:true,extra_info:['steepness']};

    /* 休憩挿入 */
    if($('restToggle').checked){ try{ const baseRoute=await fetchRoute(base,'cycling-road'); const feat=baseRoute.features[0]; const basis=$('restBasis').value; let rests=[]; if(basis==='time'){ rests=await makeRestByTime(feat,Number($('restMinutes').value)*60);} else if(basis==='energy'){ const mass=Number($('riderWeight').value)+Number($('bikeWeight').value); rests=await makeRestByEnergy(feat,mass,Number($('flatKJperKm').value),Number($('restKJ').value));} else { const mass=Number($('riderWeight').value)+Number($('bikeWeight').value); rests=await makeRestByEnergyRate(feat,mass,Number($('flatKJperKm').value),Number($('restRateKJ').value),Number($('rateWindow').value));} rests.forEach(r=>pts.splice(pts.length-1,0,{...r,type:'via'})); drawList(); }
      catch(e){ console.warn('休憩挿入失敗',e.message); }
    }

    /* マーカー */
    const icc={start:'green',goal:'red',via:'blue'}; pts.forEach(p=>markerLayer.addLayer(L.marker([p.lat,p.lon],{icon:new L.Icon({iconUrl:`https://maps.gstatic.com/mapfiles/ms2/micons/${icc[p.type]}-dot.png`,iconSize:[32,32],iconAnchor:[16,32]})}).bindTooltip(p.name)));

    /* Directions (最短/最速/勾配) */
    const [shortest,fastest]=await Promise.all([
      fetchRoute({...base,preference:'shortest'},profile),
      fetchRoute({...base,preference:'fastest'},profile)
    ]);
    routeLayers.short=L.geoJSON(shortest.features[0],{pane:'routeShortest',style:{color:'#ff0000',weight:6}}).addTo(map);
    routeLayers.fast=L.geoJSON(fastest.features[0],{pane:'routeFastest',style:{color:'#0066ff',weight:6,dashArray:'4 4'}}).addTo(map);
    const alt=await fetchRoute({...base,preference:'shortest',alternative_routes:{target_count:3,share_factor:0.6,weight_factor:1.4}},profile);
    const slope=alt.features.reduce((a,b)=>((a&&a.properties)?a:b));
    routeLayers.slope=L.geoJSON(slope,{pane:'routeSlope',style:{color:'#ff9900',weight:6,opacity:0.9}}).addTo(map);
    updateLayerVisibility();

    /* サマリー */
    const s1=shortest.features[0].properties.summary,s2=fastest.features[0].properties.summary,s3=slope.properties.summary; $('routeInfo').innerHTML=`<b>最短</b> ${formatDist(s1.distance)} / ${formatDur(s1.duration)}<br><b>最速</b> ${formatDist(s2.distance)} / ${formatDur(s2.duration)}<br><b>勾配</b> ${formatDist(s3.distance)} / ${formatDur(s3.duration)}`;

    map.fitBounds(markerLayer.getBounds().pad(0.1));
  }

  function updateLayerVisibility(){ const v={short:'chkShortest',fast:'chkFastest',slope:'chkSlope'}; for(const k in routeLayers){ routeLayers[k]&&( $(v[k]).checked?routeLayers[k].addTo(map):map.removeLayer(routeLayers[k]) ); }
 }
})();
</script>
</body>
</html>
