// 地図の初期化や各種設定
let map;
let userMarker;
let userLatLng;
let watchId;
const points = [];

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 35.681236, lng: 139.767125 },
    zoom: 13,
  });

  // 現在地の取得
  if (navigator.geolocation) {
    watchId = navigator.geolocation.watchPosition(
      (position) => {
        userLatLng = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
        };
        if (!userMarker) {
          userMarker = new google.maps.Marker({
            position: userLatLng,
            map,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 8,
              fillColor: "#00F",
              fillOpacity: 0.8,
              strokeWeight: 2,
              strokeColor: "#FFF",
            },
            title: "現在地",
          });
        } else {
          userMarker.setPosition(userLatLng);
        }
        map.setCenter(userLatLng);
      },
      null,
      { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
    );
  }

  const input = document.getElementById("searchInput");
  const toggleNearby = document.getElementById("toggleNearby");
  const autocomplete = new google.maps.places.Autocomplete(input);
  autocomplete.bindTo("bounds", map);

  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();
    if (!place.geometry || !place.geometry.location) return;

    const location = {
      lat: place.geometry.location.lat(),
      lng: place.geometry.location.lng(),
    };

    // 近くの場所だけに制限するかどうかチェック
    if (toggleNearby.checked && userLatLng) {
      const dist = google.maps.geometry.spherical.computeDistanceBetween(
        new google.maps.LatLng(userLatLng),
        new google.maps.LatLng(location)
      );
      if (dist > 5000) {
        alert("現在地から5km以内の場所を選んでください。");
        return;
      }
    }

    addPoint(location, place.name);
  });

  document.getElementById("toggleNearby").addEventListener("change", () => {
    // 状態変化があったときの処理（必要なら何か書く）
  });
}

function addPoint(latlng, name = null) {
  const marker = new google.maps.Marker({
    position: latlng,
    map,
  });

  points.push({ lat: latlng.lat, lng: latlng.lng, name, marker });
  refreshPointList();
}

function refreshPointList() {
  const list = document.getElementById("pointList");
  list.innerHTML = "";

  points.forEach((pt, i) => {
    const li = document.createElement("li");
    li.draggable = true;

    let role = "";
    if (i === 0) {
      role = "出発地";
    } else if (i === points.length - 1) {
      role = "目的地";
    } else {
      role = `経由地${i}`;
    }

    const name = pt.name || `手入力地点 (${pt.lat.toFixed(6)}, ${pt.lng.toFixed(6)})`;
    li.textContent = `${role}：${name}`;

    if (pt.marker) {
      pt.marker.setLabel({
        text: `${role}`,
        color: getMarkerColor(role),
        fontWeight: "bold",
      });
      pt.marker.setTitle(`${role}：${name}`);
    }

    const delBtn = document.createElement("button");
    delBtn.textContent = "削除";
    delBtn.onclick = () => {
      pt.marker.setMap(null);
      points.splice(i, 1);
      refreshPointList();
    };

    li.appendChild(delBtn);
    list.appendChild(li);
  });
}

function getMarkerColor(role) {
  if (role === "出発地") return "green";
  if (role === "目的地") return "red";
  return "blue";
}
