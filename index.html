<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>道に沿ったルート探索＋現在地取得</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet/dist/leaflet.css"
/>
<style>
  body {
    margin: 0;
    height: 100vh;
    display: flex;
    font-family: sans-serif;
  }
  #map {
    flex: 1;
  }
  #control-panel {
    width: 300px;
    padding: 12px;
    background: #fafafa;
    box-shadow: 2px 0 6px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  label {
    font-weight: bold;
  }
  select,
  button {
    padding: 8px;
    font-size: 14px;
  }
  #status {
    font-size: 12px;
    color: #555;
    min-height: 20px;
  }
</style>
</head>
<body>

<div id="control-panel">
  <h2>ルート探索</h2>
  <label for="start-select">開始ノード</label>
  <select id="start-select"></select>

  <label for="goal-select">終了ノード</label>
  <select id="goal-select"></select>

  <button id="btn-route">ルート検索</button>
  <button id="btn-current">現在地を取得</button>
  <div id="status"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // --- 道路ネットワーク（ノードID: {lat, lon, edges:[{to, cost}]}） ---
  const graph = {
    '1': { lat: 35.681, lon: 139.766, edges: [{ to: '2', cost: 100 }, { to: '3', cost: 150 }] },
    '2': { lat: 35.682, lon: 139.767, edges: [{ to: '1', cost: 100 }, { to: '4', cost: 120 }] },
    '3': { lat: 35.680, lon: 139.768, edges: [{ to: '1', cost: 150 }, { to: '4', cost: 130 }] },
    '4': { lat: 35.683, lon: 139.769, edges: [{ to: '2', cost: 120 }, { to: '3', cost: 130 }] }
  };

  // Leaflet 地図初期化
  const map = L.map('map').setView([35.681, 139.766], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // ノードマーカー表示
  const nodeMarkers = {};
  for (const id in graph) {
    const n = graph[id];
    const m = L.circleMarker([n.lat, n.lon], {
      radius: 7,
      color: 'black',
      fillColor: 'white',
      fillOpacity: 1,
      weight: 2,
    })
      .addTo(map)
      .bindPopup(`ノード ${id}`);
    nodeMarkers[id] = m;
  }

  // セレクトボックスにノード追加
  const startSelect = document.getElementById('start-select');
  const goalSelect = document.getElementById('goal-select');
  for (const id in graph) {
    const opt1 = document.createElement('option');
    opt1.value = id;
    opt1.textContent = id;
    startSelect.appendChild(opt1);

    const opt2 = document.createElement('option');
    opt2.value = id;
    opt2.textContent = id;
    goalSelect.appendChild(opt2);
  }
  goalSelect.value = '4';

  // ヒューリスティック（直線距離）
  function heuristic(idA, idB) {
    const a = graph[idA];
    const b = graph[idB];
    const dx = a.lat - b.lat;
    const dy = a.lon - b.lon;
    return Math.sqrt(dx * dx + dy * dy);
  }

  // A*アルゴリズム
  function astar(start, goal) {
    const openSet = new Set([start]);
    const cameFrom = {};
    const gScore = {};
    const fScore = {};

    Object.keys(graph).forEach(id => {
      gScore[id] = Infinity;
      fScore[id] = Infinity;
    });
    gScore[start] = 0;
    fScore[start] = heuristic(start, goal);

    while (openSet.size > 0) {
      // fScore最小のノード選択
      let current = null;
      let minF = Infinity;
      openSet.forEach(node => {
        if (fScore[node] < minF) {
          minF = fScore[node];
          current = node;
        }
      });

      if (current === goal) {
        // 経路復元
        const path = [];
        let c = current;
        while (c) {
          path.unshift(c);
          c = cameFrom[c];
        }
        return path;
      }

      openSet.delete(current);

      graph[current].edges.forEach(edge => {
        const tentativeG = gScore[current] + edge.cost;
        if (tentativeG < gScore[edge.to]) {
          cameFrom[edge.to] = current;
          gScore[edge.to] = tentativeG;
          fScore[edge.to] = tentativeG + heuristic(edge.to, goal);
          openSet.add(edge.to);
        }
      });
    }
    return null;
  }

  // 緯度経度から最寄ノードを探す
  function findNearestNode(lat, lon) {
    let nearestId = null;
    let minDist = Infinity;
    for (const id in graph) {
      const n = graph[id];
      const dx = n.lat - lat;
      const dy = n.lon - lon;
      const dist = dx * dx + dy * dy;
      if (dist < minDist) {
        minDist = dist;
        nearestId = id;
      }
    }
    return nearestId;
  }

  // ルート描画用レイヤー
  let routeLayer = null;

  // 現在地マーカー
  let currentLocationMarker = null;

  // ルート検索イベント
  document.getElementById('btn-route').addEventListener('click', () => {
    const start = startSelect.value;
    const goal = goalSelect.value;

    if (start === goal) {
      alert('開始ノードと終了ノードは異なるものを選択してください');
      return;
    }

    const path = astar(start, goal);
    if (!path) {
      alert('経路が見つかりませんでした');
      return;
    }

    if (routeLayer) {
      map.removeLayer(routeLayer);
      routeLayer = null;
    }

    const latlngs = path.map(id => [graph[id].lat, graph[id].lon]);
    routeLayer = L.polyline(latlngs, { color: 'blue', weight: 5 }).addTo(map);

    map.fitBounds(routeLayer.getBounds().pad(0.2));
  });

  // 現在地取得イベント
  document.getElementById('btn-current').addEventListener('click', () => {
    const status = document.getElementById('status');
    if (!navigator.geolocation) {
      status.textContent = '位置情報取得に対応していません。';
      return;
    }
    status.textContent = '現在地取得中...';

    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        status.textContent = `現在地取得成功 (${lat.toFixed(5)}, ${lon.toFixed(5)})`;

        if (currentLocationMarker) {
          map.removeLayer(currentLocationMarker);
        }
        currentLocationMarker = L.marker([lat, lon], {
          title: '現在地',
          icon: L.icon({
            iconUrl:
              'https://cdn-icons-png.flaticon.com/512/64/64113.png',
            iconSize: [25, 25],
            iconAnchor: [12, 24],
          }),
        })
          .addTo(map)
          .bindPopup('現在地')
          .openPopup();

        map.setView([lat, lon], 16);

        // 最寄ノードを自動設定
        const nearest = findNearestNode(lat, lon);
        startSelect.value = nearest;
      },
      err => {
        status.textContent = `現在地取得失敗: ${err.message}`;
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  });
</script>

</body>
</html>
