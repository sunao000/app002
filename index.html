<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>地名検索＆追加デモ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 500px; }
    #pointList { list-style: none; padding-left: 0; }
    #pointList li { margin-bottom: 4px; }
  </style>
</head>
<body>
  <h2>地名検索＆地点追加デモ</h2>

  <input type="text" id="searchBox" placeholder="例：イオンモール徳島" style="width: 300px;" />
  <button id="searchBtn">検索して追加</button>

  <h3>登録地点リスト</h3>
  <ul id="pointList"></ul>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([34.0661, 134.5593], 13); // 徳島あたりの座標
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
    }).addTo(map);

    const points = [];
    const markers = [];

    const searchBox = document.getElementById('searchBox');
    const searchBtn = document.getElementById('searchBtn');
    const pointList = document.getElementById('pointList');

    searchBtn.addEventListener('click', async () => {
      const query = searchBox.value.trim();
      if (!query) {
        alert('検索ワードを入力してください');
        return;
      }

      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
        const results = await res.json();

        if (results.length === 0) {
          alert('場所が見つかりませんでした');
          return;
        }

        const place = results[0];
        const lat = parseFloat(place.lat);
        const lon = parseFloat(place.lon);
        const name = place.display_name;

        // マーカー作成＆追加
        const marker = L.marker([lat, lon]).addTo(map).bindPopup(name);
        markers.push(marker);

        // ポイント保存
        points.push({ lat, lng: lon, name });

        // マップ中央を移動して拡大
        map.setView([lat, lon], 16);

        // リスト更新
        updatePointList();

        // 入力欄クリア
        searchBox.value = '';
      } catch (e) {
        alert('検索中にエラーが発生しました');
        console.error(e);
      }
    });

    function updatePointList() {
      pointList.innerHTML = '';
      points.forEach((pt, idx) => {
        const li = document.createElement('li');
        li.textContent = `${idx + 1}: ${pt.name} (緯度:${pt.lat.toFixed(6)}, 経度:${pt.lng.toFixed(6)})`;
        pointList.appendChild(li);
      });
    }
  </script>
</body>
</html>
