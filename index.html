<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>自転車ルート比較＋休憩（入口/出口なし版） v6.0.0</title>

<!-- ライブラリ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script  src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script  src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script  src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:system-ui,sans-serif}
#map{height:500px;width:100%}
#controls{display:flex;flex-wrap:wrap;gap:8px;padding:8px;background:#f7f7f7}
#pointList{list-style:none;margin:0;padding:0}
#pointList li{display:flex;align-items:center;justify-content:space-between;padding:4px 8px;border:1px solid #ccc;background:#fafafa;margin-bottom:4px;cursor:move}
button.del{background:#d9534f;color:#fff;border:none;border-radius:4px;padding:0 6px;font-size:12px}
#searchResults{position:absolute;z-index:1000;width:260px;max-height:200px;overflow-y:auto;margin:4px 0 0;padding:0;list-style:none;border:1px solid #ccc;background:#fff}
#searchResults li{padding:4px 8px;cursor:pointer}
#searchResults li:hover{background:#e0e0e0}
#summary{padding:8px;background:#fafafa;border-top:1px solid #ddd;font-size:0.9rem}
.section{padding:8px;background:#fff;border-top:1px solid #eee}
.group{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:6px}
.small{font-size:.88em;color:#555}
details{border:1px solid #ddd;border-radius:6px;padding:6px;background:#fff}
#charts{display:none}
#charts canvas{width:800px;height:400px}
hr{border:none;border-top:1px solid #eee;margin:8px 0}
label.chk{display:inline-flex;align-items:center;gap:6px;margin-right:10px}
input[type=number]{width:90px}
</style>
</head>
<body>

<!-- ────────── 上部操作 ────────── -->
<div id="controls">
  <input id="placeInput" placeholder="地名・住所" style="width:260px">
  <button id="searchBtn">検索</button>
  <label><input type="checkbox" id="nearbyOnly"> 近くの場所のみ</label>
  <button id="locBtn">現在地追加</button>

  <input id="restToggle" type="checkbox" checked hidden>
  <button id="restModeBtn">休憩込み: ON</button>

  <button id="btnDownloadTime"  disabled>PNG（時間×累積kJ）</button>
  <button id="btnDownloadDist"  disabled>PNG（距離×累積kJ）</button>
  <label class="chk"><input type="checkbox" id="showRestLabels"> 休憩ラベル表示</label>

  <label>基準
    <select id="restBasis">
      <option value="time">時間</option>
      <option value="energy" selected>kJ</option>
    </select>
  </label>

  <span id="timeBox" class="group" style="display:none">
    <label>間隔 <input id="restMinutes" type="number" value="60" min="15" step="5"> 分</label>
  </span>
  <span id="energyBox" class="group">
    <label>しきい値 <input id="restKJ" type="number" value="500" min="100" step="50"> kJ</label>
    <button type="button" class="presetKJ" data-kj="400">400</button>
    <button type="button" class="presetKJ" data-kj="500">500</button>
    <button type="button" class="presetKJ" data-kj="650">650</button>
  </span>

  <select id="profileSelect">
    <option value="cycling-road" selected>ロードバイク</option>
    <option value="cycling-regular">自転車（一般）</option>
  </select>
  <button id="drawBtn">ルート表示</button>

  <label><input type="checkbox" id="chkShortest" checked> 最短</label>
  <label><input type="checkbox" id="chkFastest" checked> 最速</label>
  <label><input type="checkbox" id="chkSlope" checked> 勾配</label>
</div>

<!-- ────────── 設定 ────────── -->
<div class="section">
  <div class="group">
    <label>体重 <input id="riderWeight" type="number" value="65" min="30" max="150" step="0.5"> kg</label>
    <label>バイク重量 <input id="bikeWeight" type="number" value="10" min="5" max="30" step="0.1"> kg</label>
  </div>

  <details open><summary>休憩場所のカテゴリ（POI）</summary>
    <div class="small">※ ORSカテゴリID：コンビニ=451, スーパー=443, 道の駅=624, ドラッグ=518</div>
    <div class="group" id="poiCats">
      <label class="chk"><input type="checkbox" data-cat="451" checked> コンビニ</label>
      <label class="chk"><input type="checkbox" data-cat="443" checked> スーパー</label>
      <label class="chk"><input type="checkbox" data-cat="624" checked> 道の駅</label>
      <label class="chk"><input type="checkbox" data-cat="518" checked> ドラッグストア</label>
    </div>
    <div class="small">上級者向け: カンマ区切りで上書き → <input id="customCats" placeholder="451,443,624,518" style="width:200px"></div>
  </details>

  <details open><summary>積算トリガ（時間/kJ）</summary>
    <div class="group">
      <label class="chk"><input type="checkbox" id="optAccum" checked> 積算トリガを使う</label>
      <span class="small">※ 上の「基準」と「しきい値/間隔」設定を使用</span>
    </div>
  </details>

  <details open><summary>間引き・スナップ・安全装置</summary>
    <div class="group">
      <label class="chk"><input type="checkbox" id="optMinGap" checked> 最小ルート間隔を適用</label>
      <label>最小間隔 <input id="minGapRoute" type="number" value="1200" min="100" step="50"> m</label>
      <label class="chk"><input type="checkbox" id="optGreedy" checked> スコア順に貪欲選抜</label>
    </div>
    <div class="group">
      <label class="chk"><input type="checkbox" id="optForwardSnap" checked> 前方バイアスPOIスナップ</label>
      <span class="small">（OFFなら最寄り1件にスナップ）</span>
    </div>
    <div class="group">
      <label class="chk"><input type="checkbox" id="optExclusion" checked> スタート/ゴール禁止帯</label>
      <label>スタート禁止帯 <input id="startEx" type="number" value="1000" min="0" step="100"> m</label>
      <label>ゴール禁止帯 <input id="goalEx" type="number" value="1000" min="0" step="100"> m</label>
      <label class="chk"><input type="checkbox" id="optMaxCount" checked> 休憩点の上限</label>
      <label>最大数 <input id="maxCount" type="number" value="8" min="1" step="1"></label>
    </div>
  </details>

  <details><summary>詳細設定（簡易エネルギーモデル）</summary>
    <div class="small">平坦係数 (kJ/km)</div>
    <label>平坦係数 <input id="flatKJperKm" type="number" value="18" min="10" max="30" step="0.5"> kJ/km</label>
  </details>
</div>

<ul id="searchResults" hidden></ul>
<ul id="pointList"></ul>
<div id="map"></div>

<div id="summary">
  <div id="routeInfo"></div>
  <div id="distanceScore" class="muted"></div>
</div>

<!-- グラフ用オフスクリーン -->
<div id="charts">
  <canvas id="energyChart"></canvas>
</div>

<script>
/* ===== 定数 ===== */
const ORS_KEY  = '5b3ce3597851110001cf62481af47799d9c344bf86dd4b340f9f9ff9';  // ←★自分のキー
const ORS_ROOT = 'https://api.openrouteservice.org';
const PROXY    = 'https://api.allorigins.win/raw?url=';
const DEFAULT_POI_CATS = [451,443,624,518];

const RADII    = [1000,2000,3500];
const CLOSE_TO_GOAL_M = 500;
const MIN_GAP_BETWEEN_RESTS_M = 150;

/* ===== ヘルパ ===== */
function $(id){return document.getElementById(id);}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function icon(c){return new L.Icon({iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/'+c+'-dot.png',iconSize:[32,32],iconAnchor:[16,32]});}
const ICONS = {start:icon('green'),via:icon('blue'),goal:icon('red')};
function formatDist(d){return (d/1000).toFixed(2)+' km';}
function formatDur(s){var m=Math.round(s/60);return m<60? m+' 分' : (Math.floor(m/60)+' 時間 '+(m%60)+' 分');}
function safe(path, fb){try{var v=path(); return (v===undefined||v===null)?fb:v;}catch(e){return fb;}}
function steepSum(f){var vals=safe(function(){return f.properties.extras.steepness.values;},[]);var s=0;for(var i=0;i<vals.length;i++){s+=Math.abs(vals[i][2]||0);}return s;}

/* ===== 状態 ===== */
var pts=[], map, markerLayer, routeLayers={}, lastDirTs=0;
var lastFastest=null,lastMass=0,lastFlat=18;

/* ===== 初期化 ===== */
window.addEventListener('DOMContentLoaded',function(){
  map=L.map('map').setView([34.07,134.55],11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'©OpenStreetMap'}).addTo(map);
  map.createPane('routeSlope').style.zIndex=690;
  map.createPane('routeShortest').style.zIndex=700;
  map.createPane('routeFastest').style.zIndex=710;

  $('searchBtn').onclick   = function(){var q=$('placeInput').value.trim(); if(q) nomSearch(q);};
  $('locBtn').onclick      = addCurrent;
  $('drawBtn').onclick     = drawRoutes;

  $('btnDownloadTime').onclick = function(){downloadEnergyGraphByTime(lastFastest,lastMass,lastFlat);};
  $('btnDownloadDist').onclick = function(){downloadEnergyGraphByDistance(lastFastest,lastMass,lastFlat);};

  $('restModeBtn').onclick = function(){
    $('restToggle').checked=!$('restToggle').checked;
    $('restModeBtn').textContent='休憩込み: '+($('restToggle').checked?'ON':'OFF');
    drawRoutes();
  };
  $('restBasis').onchange  = function(e){
    var v=e.target.value;
    $('timeBox').style.display=(v==='time'?'inline-flex':'none');
    $('energyBox').style.display=(v==='energy'?'inline-flex':'none');
  };
  document.addEventListener('click',function(e){
    var b=e.target.closest?e.target.closest('.presetKJ'):null;
    if(b) $('restKJ').value=b.getAttribute('data-kj');
  });
  initSortable();
});

/* ===== 検索 ===== */
async function nomSearch(q){
  var url='https://nominatim.openstreetmap.org/search?format=json&limit=10&q='+encodeURIComponent(q);
  if($('nearbyOnly').checked){
    var b=map.getBounds();
    url+='&viewbox='+[b.getWest(),b.getNorth(),b.getEast(),b.getSouth()].join(',')+'&bounded=1';
  }
  var arr=await (await fetch(url)).json();
  var ul=$('searchResults'); ul.innerHTML=''; ul.hidden=!arr.length;
  arr.forEach(function(o){
    var li=document.createElement('li'); li.textContent=o.display_name;
    li.onclick=function(){addPoint({name:o.display_name,lat:+o.lat,lon:+o.lon});ul.hidden=true;$('placeInput').value='';};
    ul.appendChild(li);
  });
}

/* ===== リスト ===== */
function addPoint(p){p.type=pts.length?'':'start'; pts.forEach(function(d){if(d.type==='goal') d.type='via';}); pts.push(p); if(pts.length>1) pts[pts.length-1].type='goal'; drawList();}
function drawList(){
  var ul=$('pointList'); ul.innerHTML='';
  pts.forEach(function(p,i){
    var li=document.createElement('li'); li._idx=i;
    li.innerHTML='<span>'+p.name+(p.isRest?'（休憩）':'')+'</span>';
    var del=document.createElement('button'); del.className='del'; del.textContent='×';
    del.onclick=function(e){e.stopPropagation(); pts.splice(i,1); fixType(); drawList();};
    ul.appendChild(li); li.appendChild(del);
  });
}
function fixType(){ if(pts[0]) pts[0].type='start'; if(pts.length>1) pts[pts.length-1].type='goal'; }
function initSortable(){ new Sortable($('pointList'),{animation:150,handle:'span',onEnd:function(){pts=Array.prototype.slice.call($('pointList').children).map(function(li){return pts[li._idx];}); fixType(); drawList();}}); }

/* ===== 現在地 ===== */
function addCurrent(){navigator.geolocation.getCurrentPosition(function(p){addPoint({name:'現在地',lat:p.coords.latitude,lon:p.coords.longitude});},function(){alert('現在地取得失敗');});}

/* ===== ORS共通 ===== */
async function post(url,body){
  var r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':ORS_KEY},body:JSON.stringify(body)});
  if(!r.ok) throw new Error(r.status); return r.json();
}
async function dir(body,profile){
  var wait=1100-(Date.now()-lastDirTs); if(wait>0) await sleep(wait);
  var d=await post(ORS_ROOT+'/v2/directions/'+profile+'/geojson',body); lastDirTs=Date.now(); return d;
}

/* ── ルート入力点スナップ（道路へ吸着） ── */
async function snapPoints(points, profile, radius){
  radius = radius || 250;
  var url = ORS_ROOT + '/v2/snap/' + profile + '/json';
  var body = { locations: points.map(function(p){ return [p.lon, p.lat]; }), radius: radius };
  try{
    var r = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json','Authorization': ORS_KEY}, body: JSON.stringify(body) });
    if(!r.ok) throw new Error('snap '+r.status);
    var data = await r.json();
    var locs = (data && data.locations) ? data.locations : [];
    return points.map(function(p, i){
      var s = locs[i];
      return (s && s.location) ? {lat:s.location[1], lon:s.location[0]} : {lat:p.lat, lon:p.lon};
    });
  }catch(e){
    console.warn('snap failed', e);
    return points.map(function(p){ return {lat:p.lat, lon:p.lon}; });
  }
}

/* ===== POIカテゴリ ===== */
function getSelectedCatIds(){
  var custom=$('customCats').value.trim();
  if(custom){
    var arr=custom.split(',').map(function(s){return +s.trim();}).filter(function(n){return isFinite(n);});
    if(arr.length) return arr;
  }
  var boxes=[].slice.call(document.querySelectorAll('#poiCats input[type=checkbox]'));
  var sel=boxes.filter(function(b){return b.checked;}).map(function(b){return +b.getAttribute('data-cat');});
  return sel.length? sel : DEFAULT_POI_CATS.slice();
}

/* ===== POI検索 ===== */
async function nearPoi(lat,lon,categoryIds){
  for(var i=0;i<RADII.length;i++){
    var buf=RADII[i];
    var qs=new URLSearchParams({
      api_key:ORS_KEY,request:'pois',limit:20,sortby:'distance',
      geometry:JSON.stringify({buffer:buf,geojson:{type:'Point',coordinates:[lon,lat]}}),
      filters:JSON.stringify({category_ids:categoryIds})
    });
    try{
      var r=await fetch(PROXY+encodeURIComponent(ORS_ROOT+'/pois?'+qs.toString()));
      if(!r.ok) throw new Error();
      var d=await r.json();
      if(d && d.features && d.features.length) return d.features[0];
    }catch(e){}
  }
  return {geometry:{coordinates:[lon,lat]},properties:{name:'休憩'}};
}

function isClose(lat,lon){
  var g=pts.length? pts[pts.length-1] : null;
  return g? L.latLng(lat,lon).distanceTo([g.lat,g.lon])<=CLOSE_TO_GOAL_M : false;
}
function distLL(aLat,aLon,bLat,bLon){return L.latLng(aLat,aLon).distanceTo([bLat,bLon]);}

/* ===== エネルギー ===== */
function energyStepKJ(d,dz,m,flat){return flat*(d/1000)+Math.max(dz,0)*m*9.80665/1000;}

/* ===== 距離累積 ===== */
function buildCumDistArray(coords){
  var cd=[0];
  for(var i=1;i<coords.length;i++){
    var lon=coords[i][0], lat=coords[i][1], plon=coords[i-1][0], plat=coords[i-1][1];
    cd[i]=cd[i-1]+L.latLng(lat,lon).distanceTo([plat,plon]);
  }
  return cd;
}
function totalDist(cum){return cum[cum.length-1];}
function findPointAtRouteD(coords, cum, targetD){
  if(targetD<=0){ return {lat:coords[0][1], lon:coords[0][0]}; }
  var total=totalDist(cum);
  if(targetD>=total){ var Lp=coords[coords.length-1]; return {lat:Lp[1],lon:Lp[0]}; }
  var i=1; while(i<coords.length && cum[i]<targetD) i++;
  var i0=i-1, i1=i, d=cum[i1]-cum[i0]||1, r=(targetD-cum[i0])/d;
  var lon0=coords[i0][0], lat0=coords[i0][1], lon1=coords[i1][0], lat1=coords[i1][1];
  return {lat: lat0+(lat1-lat0)*r, lon: lon0+(lon1-lon0)*r};
}

/* ===== グラフ用（休憩→X軸位置） ===== */
function buildCumTimeByCoord(feature){
  const coords = feature.geometry.coordinates;
  const segs = (feature.properties.segments||[]);
  const T = new Array(coords.length).fill(0);
  let cur = 0;
  segs.forEach(function(seg){
    (seg.steps||[]).forEach(function(st){
      const wp = st.way_points||[0,0];
      const i0 = wp[0], i1 = wp[1], dt = st.duration||0;
      T[i0] = cur;
      cur += dt;
      T[i1] = cur;
    });
  });
  for(let i=1;i<T.length;i++){ if(T[i]===0 && T[i-1]>0) T[i]=T[i-1]; }
  return T;
}
function buildRestMarksByDistance(feature, labelsKM, restPts){
  const coords = feature.geometry.coordinates;
  const cum = buildCumDistArray(coords);
  const nums = labelsKM.map(function(s){return +s;});
  const marks = [];
  (restPts||[]).forEach(function(r){
    let best = 0, bestDist = 1e12;
    for(let i=0;i<coords.length;i++){
      const d = L.latLng(r.lat,r.lon).distanceTo([coords[i][1],coords[i][0]]);
      if(d < bestDist){ bestDist = d; best = i; }
    }
    const km = (cum[best]||0)/1000;
    let j = 0; while(j<nums.length && nums[j] < km) j++;
    if(j>=nums.length) j = nums.length-1;
    marks.push({ xIndex: j, name: r.name || '休憩' });
  });
  return marks.sort(function(a,b){return a.xIndex-b.xIndex;});
}
function buildRestMarksByTime(feature, labelsMin, restPts){
  const coords = feature.geometry.coordinates;
  const T = buildCumTimeByCoord(feature);
  const nums = labelsMin.map(function(s){return +s;});
  const marks = [];
  (restPts||[]).forEach(function(r){
    let best = 0, bestDist = 1e12;
    for(let i=0;i<coords.length;i++){
      const d = L.latLng(r.lat,r.lon).distanceTo([coords[i][1],coords[i][0]]);
      if(d < bestDist){ bestDist = d; best = i; }
    }
    const min = (T[best]||0)/60;
    let j = 0; while(j<nums.length && nums[j] < min) j++;
    if(j>=nums.length) j = nums.length-1;
    marks.push({ xIndex: j, name: r.name || '休憩' });
  });
  return marks.sort(function(a,b){return a.xIndex-b.xIndex;});
}

/* ===== 休憩注記（破線のみ／任意でラベル） ===== */
const RestAnno = {
  id: 'restAnno',
  afterDatasetsDraw(chart, args, pluginOpts){
    const marks = (pluginOpts && pluginOpts.restMarks) || [];
    if(!marks.length) return;
    const showLabels = !!(pluginOpts && pluginOpts.showLabels);
    const dash       = (pluginOpts && pluginOpts.dash) || [6,6];
    const color      = (pluginOpts && pluginOpts.lineColor) || '#bbb';
    const lw         = (pluginOpts && pluginOpts.lineWidth) || 1;

    const ctx  = chart.ctx;
    const area = chart.chartArea;
    const meta = chart.getDatasetMeta(0);

    ctx.save();
    ctx.font = '12px system-ui';

    marks.forEach(function(m){
      const el = meta.data[m.xIndex];
      if(!el) return;
      const x = el.x;

      ctx.setLineDash(dash);
      ctx.strokeStyle = color;
      ctx.lineWidth   = lw;
      ctx.beginPath();
      ctx.moveTo(x, area.top);
      ctx.lineTo(x, area.bottom);
      ctx.stroke();
      ctx.setLineDash([]);

      if(showLabels){
        const text = '休憩: ' + (m.name || '');
        const tw = ctx.measureText(text).width;
        const bx = x + 6, by = area.top + 6;
        ctx.fillStyle = 'rgba(255,255,255,0.85)';
        ctx.fillRect(bx, by, tw + 8, 18);
        ctx.fillStyle = '#333';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, bx + 4, by + 9);
      }
    });
    ctx.restore();
  }
};
if (typeof Chart !== 'undefined') Chart.register(RestAnno);

/* ===== グラフ（PNG出力） ===== */
function tempShowChartsContainer(show){
  var c=$('charts');
  if(show){c.style.display='block';c.style.position='absolute';c.style.left='-99999px';c.style.visibility='hidden';}
  else{c.removeAttribute('style');c.style.display='none';}
}
function prepareCanvasSize(canvas,w,h){canvas.width=w||1600;canvas.height=h||900;}
function energyStepSeries(feature,mass,flat,mode){ // mode: 'time' or 'dist'
  var coords=feature.geometry.coordinates, hasEle=(coords[0].length>=3);
  var cum=0,cumE=0, X=[],E=[];
  var segs=feature.properties.segments||[];
  for(var si=0;si<segs.length;si++){
    var steps=segs[si].steps||[];
    for(var st=0;st<steps.length;st++){
      var wp=steps[st].way_points||[0,0], i0=wp[0], i1=wp[1], d=steps[st].distance||0, dt=steps[st].duration||0;
      var dz=hasEle? ((coords[i1][2]||0)-(coords[i0][2]||0)) : 0;
      var dE=energyStepKJ(d,dz,mass,flat);
      cum+=(mode==='time'? dt/60 : d/1000);
      cumE+=dE; X.push(+cum.toFixed(2)); E.push(+cumE.toFixed(1));
    }
  }
  return {labels:X,values:E};
}
function downloadLineChart(obj){
  tempShowChartsContainer(true);
  var ec=$('energyChart'); prepareCanvasSize(ec,1600,900);
  var ch=new Chart(ec,{
    type:'line',
    data:{labels:obj.labels,datasets:[{label:obj.ylabel,data:obj.values,borderWidth:2,pointRadius:0}]},
    options:{
      animation:false,
      scales:{x:{title:{display:true,text:obj.xlabel}},y:{title:{display:true,text:obj.ylabel}}},
      plugins:{
        legend:{display:false},
        restAnno:{
          restMarks:obj.restMarks||[],
          showLabels:$('showRestLabels')&&$('showRestLabels').checked,
          lineColor:'#bbb',lineWidth:1,dash:[6,6]
        }
      }
    }
  });
  setTimeout(function(){
    ec.toBlob(function(b){
      if(!b){alert('PNG生成失敗');return;}
      var u=URL.createObjectURL(b),a=document.createElement('a');
      a.href=u;a.download=obj.filename;a.click();
      setTimeout(function(){URL.revokeObjectURL(u);ch.destroy();tempShowChartsContainer(false);},1000);
    },'image/png');
  },120);
}
function downloadEnergyGraphByTime(f,mass,flat){
  if(!f){alert('先にルートを描画');return;}
  var s=energyStepSeries(f,mass,flat,'time');
  var marks=buildRestMarksByTime(f,s.labels,pts.filter(function(p){return p.isRest;}));
  downloadLineChart({labels:s.labels,values:s.values,xlabel:'時間 (分)',ylabel:'累積エネルギー (kJ)',filename:'energy_over_time.png',restMarks:marks});
}
function downloadEnergyGraphByDistance(f,mass,flat){
  if(!f){alert('先にルートを描画');return;}
  var s=energyStepSeries(f,mass,flat,'dist');
  var marks=buildRestMarksByDistance(f,s.labels,pts.filter(function(p){return p.isRest;}));
  downloadLineChart({labels:s.labels,values:s.values,xlabel:'距離 (km)',ylabel:'累積エネルギー (kJ)',filename:'energy_over_distance.png',restMarks:marks});
}

/* ===== 休憩ロジック（積算のみ） ===== */
async function makeRestAdvanced(previewFeature,basis,mass,flat,thr){
  var coords=previewFeature.geometry.coordinates;
  var segs=safe(function(){return previewFeature.properties.segments;},[])||[];
  var hasEle=(coords[0].length>=3);
  var cum=buildCumDistArray(coords);
  var total=totalDist(cum);

  var startEx = $('optExclusion').checked ? (Number($('startEx').value)||0) : 0;
  var goalEx  = $('optExclusion').checked ? (Number($('goalEx').value)||0) : 0;
  var minGapRoute = $('optMinGap').checked ? (Number($('minGapRoute').value)||0) : 0;
  var useGreedy = $('optGreedy').checked;

  function inExclusion(routeD){ return (routeD<startEx) || ((total-routeD)<goalEx); }

  var cands=[];
  if($('optAccum').checked){
    var acc=0;
    for(var si=0;si<segs.length;si++){
      var steps=segs[si].steps||[];
      for(var st=0;st<steps.length;st++){
        var wp=steps[st].way_points||[0,0], i0=wp[0], i1=wp[1], d=steps[st].distance||0, t=steps[st].duration||0;
        var dz=hasEle? ((coords[i1][2]||0)-(coords[i0][2]||0)) : 0;
        var dE=energyStepKJ(d,dz,mass,flat);
        acc += (basis==='time') ? t : dE;
        if(acc>=thr){
          var P={lat:coords[i1][1], lon:coords[i1][0], routeD:cum[i1]};
          cands.push({kind:'ACCUM',lat:P.lat,lon:P.lon,routeD:P.routeD});
          acc=0;
        }
      }
    }
  }

  // ゴール近傍＆禁止帯
  var goalPt = pts.length? L.latLng(pts[pts.length-1].lat, pts[pts.length-1].lon) : null;
  var alive = cands.filter(function(c){
    if(goalPt && goalPt.distanceTo([c.lat,c.lon])<=CLOSE_TO_GOAL_M) return false;
    if(inExclusion(c.routeD)) return false;
    return true;
  });

  // 最小間隔選抜
  if($('optMinGap').checked) alive=selectByMinGap(alive, minGapRoute, useGreedy);
  else alive.sort(function(a,b){return a.routeD-b.routeD;});

  // 上限
  if($('optMaxCount').checked){
    var mx=Number($('maxCount').value)||9999;
    if(alive.length>mx) alive=alive.slice(0,mx);
  }

  // POI スナップ
  var out=[], categoryIds=getSelectedCatIds();
  for(var ai=0;ai<alive.length;ai++){
    var c=alive[ai], poi;
    if($('optForwardSnap').checked){
      poi = await nearPoiForwardSnap(c, categoryIds, coords, cum);
    }else{
      var f = await nearPoi(c.lat, c.lon, categoryIds);
      poi = {lat:f.geometry.coordinates[1], lon:f.geometry.coordinates[0], name:(f.properties&&f.properties.name)?f.properties.name:'休憩'};
    }
    if(goalPt && goalPt.distanceTo([poi.lat,poi.lon])<=CLOSE_TO_GOAL_M) continue;
    var tooClose=false;
    for(var r=0;r<out.length;r++){ if(distLL(out[r].lat,out[r].lon,poi.lat,poi.lon)<MIN_GAP_BETWEEN_RESTS_M){ tooClose=true; break; } }
    if(tooClose) continue;
    out.push({name:poi.name,lat:poi.lat,lon:poi.lon,type:'via',isRest:true});
  }
  return out;
}

/* ===== 候補スコア＆選抜 ===== */
function scoreCandidate(c){return 1;} // 積算候補は等価
function selectByMinGap(cands, minGapRoute, useGreedy){
  minGapRoute = Number(minGapRoute)||1200;
  var kept=[];
  (cands.slice().sort(function(a,b){return a.routeD-b.routeD;})).forEach(function(c){
    var ok=true;
    for(var i=0;i<kept.length;i++){ if(Math.abs(kept[i].routeD-c.routeD)<minGapRoute){ ok=false; break; } }
    if(ok) kept.push(c);
  });
  return kept;
}

/* ===== 前方バイアスPOIスナップ ===== */
var CAT_W = { '624':80, '451':70, '443':60, '518':50 };
function xyMeters(baseLat,A,B){var latm=110540,lonm=111320*Math.cos(baseLat*Math.PI/180);return {x:(B.lon-A.lon)*lonm,y:(B.lat-A.lat)*latm};}
function localForwardVec(coords,cum,routeD){
  var i=1; while(i<cum.length && cum[i]<routeD) i++;
  var j=Math.max(0, Math.min(coords.length-2, i-1));
  var A={lat:coords[j][1],lon:coords[j][0]}, B={lat:coords[j+1][1],lon:coords[j+1][0]};
  var base=(A.lat+B.lat)/2; return xyMeters(base,A,B);
}
async function nearPoiForwardSnap(cand, categoryIds, coords, cum){
  var baseLat = coords[0][1];
  var radii=[1000,2000,3500];
  for(var ri=0;ri<radii.length;ri++){
    var radius=radii[ri];
    var qs=new URLSearchParams({
      api_key:ORS_KEY,request:'pois',limit:20,sortby:'distance',
      geometry:JSON.stringify({buffer:radius,geojson:{type:'Point',coordinates:[cand.lon,cand.lat]}}),
      filters:JSON.stringify({category_ids:categoryIds})
    });
    try{
      var r=await fetch(PROXY+encodeURIComponent(ORS_ROOT+'/pois?'+qs.toString()));
      if(!r.ok) continue;
      var d=await r.json();
      if(!(d && d.features && d.features.length)) continue;

      var v=localForwardVec(coords, cum, cand.routeD);
      var best=null,bestScore=-1e9;
      for(var k=0;k<d.features.length;k++){
        var f=d.features[k];
        var plon=f.geometry.coordinates[0], plat=f.geometry.coordinates[1];
        var cats=(f.properties && f.properties.category_ids) ? f.properties.category_ids : [];
        var cat=String(cats.length?cats[0]:'');
        var wCat = CAT_W.hasOwnProperty(cat)? CAT_W[cat] : 40;

        var w=xyMeters(baseLat,{lat:cand.lat,lon:cand.lon},{lat:plat,lon:plon});
        var dot=v.x*w.x+v.y*w.y;
        var ahead = dot>=0;

        var j=1; while(j<cum.length && cum[j]<cand.routeD) j++;
        var poiRouteD=cum[Math.max(0,Math.min(cum.length-1,j))];

        var backPenalty = (poiRouteD < cand.routeD - 50) ? -800 : 0;
        var dist=L.latLng(cand.lat,cand.lon).distanceTo([plat,plon]);
        var score=(-dist)+(ahead?150:-80)+wCat+backPenalty;
        if(score>bestScore){bestScore=score;best={lat:plat,lon:plon,name:(f.properties&&f.properties.name)?f.properties.name:'休憩'};}
      }
      if(best) return best;
    }catch(e){}
  }
  return {lat:cand.lat,lon:cand.lon,name:'休憩'};
}

/* ===== ルート描画 ===== */
async function drawRoutes(){
  $('btnDownloadTime').disabled=true;
  $('btnDownloadDist').disabled=true;
  lastFastest=null;

  if(pts.length<2){alert('2地点以上登録してください');return;}

  Object.keys(routeLayers).forEach(function(k){if(routeLayers[k]) map.removeLayer(routeLayers[k]);}); routeLayers={};
  if(markerLayer) map.removeLayer(markerLayer);

  // 以前の休憩を除去
  pts = pts.filter(function(p){return !p.isRest;});
  fixType(); drawList();

  var profile=$('profileSelect').value;
  var mass=Number($('riderWeight').value)+Number($('bikeWeight').value);
  var flat=Number($('flatKJperKm').value);
  var basis=$('restBasis').value;
  var thr=basis==='time' ? (Number($('restMinutes').value)*60) : Number($('restKJ').value);

  // 休憩プレビュー（積算のみ）
  try{
    if($('restToggle').checked){
      var preview=await dir({coordinates:pts.map(function(p){return [p.lon,p.lat];}),elevation:true,extra_info:['steepness'],preference:'fastest'},profile);
      var feat=safe(function(){return preview.features[0];},null);
      if(feat){
        var rests=await makeRestAdvanced(feat,basis,mass,flat,thr);
        if(rests.length){
          var insertPos=Math.max(pts.length-1,1);
          Array.prototype.splice.apply(pts,[insertPos,0].concat(rests));
          fixType(); drawList();
        }
      }
    }
  }catch(e){console.warn('休憩地点取得失敗',e);}

  // マーカー
  markerLayer=L.layerGroup().addTo(map);
  pts.forEach(function(p){
    var ic=p.type==='start'?ICONS.start:(p.type==='goal'?ICONS.goal:ICONS.via);
    markerLayer.addLayer(L.marker([p.lat,p.lon],{icon:ic}).bindTooltip(p.name+(p.isRest?'（休憩）':'')));
  });

  // スナップ後にルート描画
  try{
    var routingPts = await snapPoints(pts, profile, 250);
    var coordsRouting = routingPts.map(function(p){ return [p.lon, p.lat]; });

    var base = {
      coordinates: coordsRouting,
      elevation: true,
      extra_info: ['steepness','surface','waytype'],
      options: { avoid_features: ['steps'], profile_params: { weightings: { steepness_difficulty: 1 } } }
    };

    var shortest = await dir(Object.assign({},base,{preference:'shortest'}),profile);
    var fastest  = await dir(Object.assign({},base,{preference:'fastest'}), profile);
    var slope    = shortest.features[0];

    if(coordsRouting.length===2){
      var alt = await dir(Object.assign({},base,{ preference:'shortest', alternative_routes:{ target_count:3, share_factor:0.6, weight_factor:1.4 }}), profile);
      var feats = alt.features || [];
      if(feats.length){ slope = feats.reduce(function(a,b){ return steepSum(a)<steepSum(b)?a:b; }); }
    }

    routeLayers.short=L.geoJSON(shortest.features[0],{pane:'routeShortest',style:{color:'#ff0000',weight:6}}).addTo(map);
    routeLayers.fast =L.geoJSON(fastest.features[0] ,{pane:'routeFastest', style:{color:'#0066ff',weight:6,dashArray:'4 4'}}).addTo(map);
    routeLayers.slope=L.geoJSON(slope               ,{pane:'routeSlope' , style:{color:'#ff9900',weight:6,opacity:0.9}}).addTo(map);
    updateLayerVisibility();

    var bounds=new L.LatLngBounds();
    markerLayer.eachLayer(function(l){bounds.extend(l.getLatLng());});
    Object.keys(routeLayers).forEach(function(k){bounds.extend(routeLayers[k].getBounds());});
    if(bounds.isValid()) map.fitBounds(bounds.pad(0.1));

    var s1=shortest.features[0].properties.summary, s2=fastest.features[0].properties.summary, s3=slope.properties.summary;
    $('routeInfo').innerHTML=
      '<b>最短</b> '+formatDist(s1.distance)+' / '+formatDur(s1.duration)+'<br>'+
      '<b>最速</b> '+formatDist(s2.distance)+' / '+formatDur(s2.duration)+'<br>'+
      '<b>勾配</b> '+formatDist(s3.distance)+' / '+formatDur(s3.duration);
    $('distanceScore').textContent='距離差: '+(s2.distance-s1.distance).toFixed(0)+' m';

    lastFastest=fastest.features[0]; lastMass=mass; lastFlat=flat;
    $('btnDownloadTime').disabled=false;
    $('btnDownloadDist').disabled=false;
  }catch(e){
    console.error(e);
    alert('ルート取得失敗: '+e.message);
  }
}
function updateLayerVisibility(){
  var m={short:'chkShortest',fast:'chkFastest',slope:'chkSlope'};
  Object.keys(routeLayers).forEach(function(k){
    if($(m[k]).checked) routeLayers[k].addTo(map); else map.removeLayer(routeLayers[k]);
  });
}
</script>
</body>
</html>
